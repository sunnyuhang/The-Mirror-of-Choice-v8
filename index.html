<!DOCTYPE html>

<html lang="zh-CN">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>å†³ç­–ä¹‹é•œï¼ˆ30ç»„é»‘å®¢æ¾ï¼‰ - é€šè¿‡æ²‰æµ¸å¼æ•…äº‹æ¢ç´¢å†³ç­–ç»“æœ</title>
<style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #1a2a6c 0%, #2a4b8d 100%);
            color: #fff;
            min-height: 100vh;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        
        .container {
            max-width: 1000px;
            width: 100%;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            text-align: center;
            position: relative;
            overflow: hidden;
        }
        
        .container::before {
            content: "";
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
            z-index: -1;
        }
        
        h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
        }
        
        .subtitle {
            font-size: 1.2rem;
            margin-bottom: 30px;
            opacity: 0.9;
        }
        
        .step-container {
            display: none;
            animation: fadeIn 0.5s ease;
        }
        
        .step-container.active {
            display: block;
        }
        
        .step-title {
            font-size: 1.8rem;
            margin-bottom: 20px;
            color: #4fc3f7;
        }
        
        .step-description {
            font-size: 1.1rem;
            margin-bottom: 30px;
            line-height: 1.6;
        }
        
        .input-section {
            margin: 30px 0;
            text-align: left;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
        }
        
        input, select, textarea {
            width: 100%;
            padding: 12px 15px;
            border: none;
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            font-size: 1rem;
        }
        
        /* ä¿®å¤MBTIé€‰æ‹©æ¡†å­—ä½“é¢œè‰²é—®é¢˜ */
        select option {
            background: #2a4b8d;
            color: white;
        }
        
        input::placeholder, textarea::placeholder {
            color: rgba(255, 255, 255, 0.7);
        }
        
        .form-row {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .form-col {
            flex: 1;
        }
        
        .story-section {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 25px;
            margin: 30px 0;
            text-align: left;
            line-height: 1.7;
            border-left: 4px solid #4fc3f7;
        }
        
        .story-title {
            font-size: 1.4rem;
            margin-bottom: 15px;
            color: #4fc3f7;
        }
        
        .options-container {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            justify-content: center;
            margin: 30px 0;
        }
        
        .option-card {
            background: rgba(255, 255, 255, 0.15);
            border-radius: 15px;
            padding: 20px;
            width: calc(50% - 15px);
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }
        
        .option-card:hover {
            transform: translateY(-5px);
            background: rgba(255, 255, 255, 0.25);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }
        
        .option-card.selected {
            border-color: #4fc3f7;
            background: rgba(79, 195, 247, 0.2);
        }
        
        .option-title {
            font-size: 1.2rem;
            margin-bottom: 10px;
            color: #4fc3f7;
        }
        
        .option-description {
            font-size: 0.95rem;
            line-height: 1.5;
        }
        
        button {
            background: linear-gradient(to right, #2196F3, #03A9F4);
            color: white;
            border: none;
            padding: 15px 40px;
            font-size: 1.1rem;
            border-radius: 50px;
            cursor: pointer;
            margin: 20px 0;
            transition: all 0.3s ease;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }
        
        button:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
        }
        
        button:disabled {
            background: #666;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .nav-buttons {
            display: flex;
            justify-content: space-between;
            margin-top: 30px;
        }
        
        .nav-btn {
            padding: 12px 25px;
            font-size: 1rem;
        }
        
        .back-btn {
            background: linear-gradient(to right, #667eea, #764ba2);
        }
        
        .progress-container {
            width: 100%;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            height: 10px;
            margin: 30px 0;
            overflow: hidden;
        }
        
        .progress-bar {
            height: 100%;
            background: linear-gradient(to right, #2196F3, #03A9F4);
            border-radius: 10px;
            width: 0%;
            transition: width 0.5s ease;
        }
        
        .step-indicators {
            display: flex;
            justify-content: center;
            margin-bottom: 20px;
        }
        
        .step-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            margin: 0 5px;
            transition: all 0.3s ease;
        }
        
        .step-indicator.active {
            background: #4fc3f7;
            transform: scale(1.2);
        }
        
        .result-section {
            display: none;
            margin-top: 30px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            text-align: left;
            animation: fadeIn 1s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .result-title {
            font-size: 1.8rem;
            margin-bottom: 15px;
            text-align: center;
            color: #4fc3f7;
        }
        
        .result-content {
            line-height: 1.6;
            font-size: 1.1rem;
        }
        
        .consequence-section {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
            border-left: 4px solid #FF9800;
        }
        
        .consequence-title {
            font-size: 1.3rem;
            margin-bottom: 10px;
            color: #FF9800;
        }
        
        .reflection-questions {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
            border-left: 4px solid #4CAF50;
        }
        
        .reflection-title {
            font-size: 1.3rem;
            margin-bottom: 10px;
            color: #4CAF50;
        }
        
        .loading {
            display: none;
            margin: 20px 0;
        }
        
        .spinner {
            border: 5px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 5px solid #fff;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .decoration {
            position: absolute;
            opacity: 0.1;
            z-index: -1;
        }
        
        .decoration-1 {
            top: 10%;
            left: 5%;
            font-size: 100px;
        }
        
        .decoration-2 {
            bottom: 10%;
            right: 5%;
            font-size: 80px;
            transform: rotate(180deg);
        }
        
        .disclaimer {
            margin-top: 20px;
            font-size: 0.9rem;
            opacity: 0.7;
            text-align: center;
        }
        
        .character-badge {
            display: inline-block;
            background: rgba(79, 195, 247, 0.3);
            padding: 5px 12px;
            border-radius: 20px;
            margin: 0 5px 10px 0;
            font-size: 0.9rem;
        }
        
        .character-section {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
            text-align: left;
        }
        
        .character-title {
            font-size: 1.3rem;
            margin-bottom: 15px;
            color: #4fc3f7;
            text-align: center;
        }
        
        .story-image {
            width: 100%;
            height: 100px;
            border-radius: 10px;
            background: transparent;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3rem;
            opacity: 0.7;
        }
        
        .choice-result {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
            border-left: 4px solid #FF9800;
        }
        
        .choice-title {
            font-size: 1.3rem;
            margin-bottom: 10px;
            color: #FF9800;
        }
        
        /* æ–°å¢æ ·å¼ */
        .input-hint {
            font-size: 0.9rem;
            color: rgba(255, 255, 255, 0.7);
            margin-top: 5px;
            font-style: italic;
        }
        
        .life-review-section {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
            border-left: 4px solid #9C27B0;
        }
        
        .life-review-title {
            font-size: 1.3rem;
            margin-bottom: 10px;
            color: #9C27B0;
        }
        
        .decision-review {
            margin: 15px 0;
            padding: 15px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
        }
        
        .decision-review-title {
            font-size: 1.1rem;
            margin-bottom: 10px;
            color: #4fc3f7;
        }
        
        .alternative-outcome {
            margin-top: 10px;
            padding: 10px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            border-left: 3px solid #FF9800;
        }
        
        .alternative-title {
            font-size: 1rem;
            margin-bottom: 5px;
            color: #FF9800;
        }
        
        
        .ending-section {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
            border-left: 4px solid #00BCD4;
        }
        
        .ending-title {
            font-size: 1.3rem;
            margin-bottom: 10px;
            color: #00BCD4;
        }

        .risk-indicator {
            margin-top: 10px;
            font-size: 0.9rem;
            padding: 5px 10px;
            border-radius: 15px;
            display: inline-block;
        }
        
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            color: white;
            font-size: 1.2rem;
        }
        
        .loading-overlay .spinner {
            border: 5px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 5px solid #fff;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 20px;
            }
            
            h1 {
                font-size: 2rem;
            }
            
            .subtitle {
                font-size: 1rem;
            }
            
            .option-card {
                width: 100%;
            }
            
            .form-row {
                flex-direction: column;
                gap: 0;
            }
        }

/* --- ä»¥ä¸‹ä¸ºä» a5 åˆå¹¶çš„ç¬¬1é¡µæ ·å¼ --- */
/* ä»…ç¬¬1é¡µæ–°å¢çš„å°‘é‡æ ·å¼ */
    .req::after{content:" *";color:#ffdf6b}
    .chip-group{display:flex;flex-wrap:wrap;gap:10px}
    .chip{padding:8px 12px;border-radius:999px;background:rgba(255,255,255,.18);border:1px solid rgba(255,255,255,.2);cursor:pointer;font-size:.95rem;user-select:none}
    .chip:hover{background:rgba(255,255,255,.28)}
    .chip.selected{border-color:#4fc3f7;background:rgba(79,195,247,.25)}
    .hint{font-size:.9rem;opacity:.85;margin-top:6px}
    .muted{opacity:.9}
    .mbti-box{border:1px solid rgba(255,255,255,.2);border-radius:12px;padding:12px;background:rgba(0,0,0,.15)}
</style>
</head>
<body>
<div class="container">
<div class="decoration decoration-1">ğŸ“–</div>
<div class="decoration decoration-2">ğŸ“–</div>
<h1>å†³ç­–ä¹‹é•œ<span class="subtitle-badge">ï¼ˆ30ç»„é»‘å®¢æ¾ï¼‰</span></h1>
<p class="subtitle">é€šè¿‡æ²‰æµ¸å¼æ•…äº‹æ¢ç´¢ä¸åŒå†³ç­–çš„å¯èƒ½ç»“æœ</p>
<!-- è¿›åº¦æ¡ -->
<div class="progress-container">
<div class="progress-bar" id="progressBar"></div>
</div>
<!-- æ­¥éª¤æŒ‡ç¤ºå™¨ -->
<div class="step-indicators" id="stepIndicators"></div>
<!-- æ­¥éª¤1: åŸºæœ¬ä¿¡æ¯ -->
<div class="step-container active" id="step1">
<h2 class="step-title">ç¬¬ä¸€æ­¥ï¼šåˆ›å»ºæ‚¨çš„è§’è‰²</h2>
<p class="step-description">å§“åã€å¹´é¾„ä¸ºå¿…å¡«ï¼›èŒä¸šæ”¯æŒâ€œè¡Œä¸šâ†’å²—ä½â†’å…¶ä»–ï¼ˆè‡ªå¡«ï¼‰â€ï¼›MBTI ç”¨é€ŸæŸ¥è¡¨ä¸å¿«é€‰ä¸€é”®é€‰æ‹©ã€‚</p>
<div class="input-section">
<!-- å§“å / å¹´é¾„ï¼ˆå¿…å¡«ï¼‰ -->
<div class="form-row">
<div class="form-col">
<div class="form-group">
<label class="req" for="name">å§“å</label>
<input id="name" placeholder="è¯·è¾“å…¥æ‚¨çš„å§“å" required="" type="text"/>
</div>
</div>
<div class="form-col">
<div class="form-group">
<label class="req" for="age">å¹´é¾„</label>
<input id="age" max="120" min="1" placeholder="è¯·è¾“å…¥æ‚¨çš„å¹´é¾„" required="" type="number"/>
</div>
</div>
</div>
<!-- èŒä¸šï¼ˆè¡Œä¸šâ†’å²—ä½ï¼Œå¹¶æ”¯æŒâ€œå…¶ä»–ï¼ˆè¯·å¡«å†™ï¼‰â€ï¼‰ -->
<div class="form-row">
<div class="form-col">
<div class="form-group">
<label>è¡Œä¸šï¼ˆå¯é€‰ï¼‰</label>
<select id="industry">
<option value="">è¯·é€‰æ‹©è¡Œä¸š</option>
<option>IT/äº’è”ç½‘</option><option>é‡‘è/é“¶è¡Œ/ä¿é™©</option><option>æ•™è‚²/åŸ¹è®­/é«˜æ ¡</option>
<option>åŒ»ç–—/åˆ¶è¯/ç”Ÿç‰©</option><option>åˆ¶é€ /å·¥ä¸š/æ±½è½¦</option><option>èƒ½æº/åŒ–å·¥/çŸ¿ä¸š</option>
<option>å»ºç­‘/å·¥ç¨‹/æˆ¿åœ°äº§</option><option>äº¤é€š/ç‰©æµ/ä¾›åº”é“¾</option><option>é›¶å”®/ç”µå•†/å¿«æ¶ˆ</option>
<option>æ–‡å¨±/ä¼ åª’/æ¸¸æˆ</option><option>æ³•å¾‹/å’¨è¯¢/ä¼šè®¡</option><option>æ”¿åºœ/å…¬å…±äº‹ä¸š/äº‹ä¸šå•ä½</option>
<option>å†œä¸š/ç¯ä¿/æ–°èƒ½æº</option><option>æ—…æ¸¸/é…’åº—/é¤é¥®</option><option>éè¥åˆ©/å…¬ç›Š</option>
<option>è‡ªç”±èŒä¸š/ä¸ªä½“</option><option>å…¶ä»–</option>
</select>
</div>
</div>
<div class="form-col">
<div class="form-group">
<label>å²—ä½ï¼ˆå¯é€‰ï¼‰</label>
<select disabled="" id="role">
<option value="">è¯·å…ˆé€‰æ‹©è¡Œä¸š</option>
</select>
<!-- è‡ªå®šä¹‰å²—ä½ -->
<div class="form-group" id="roleOtherWrap" style="display:none;margin-top:8px;">
<input id="roleOther" placeholder="è¯·è¾“å…¥è‡ªå®šä¹‰å²—ä½" type="text"/>
</div>
</div>
</div>
</div>
<!-- æ±‡æ€»ä¸º professionï¼ˆå…¼å®¹åŸç‰ˆï¼‰ -->
<input id="profession" type="hidden" value=""/>
<!-- MBTIï¼šå¿«é€‰ + 16 å‹é€ŸæŸ¥ chips + è¯´æ˜ -->
<div class="form-group">
<label>MBTI æ€§æ ¼ç±»å‹ï¼ˆç‚¹å‡»é€‰æ‹©ï¼‰</label>
<div class="chip-group" id="mbtiQuick" style="margin-bottom:6px"></div>
<div class="chip-group" id="mbtiChips"></div>
<div class="mbti-box" id="mbtiExplainWrap" style="display:none; margin-top:8px;">
<b id="mbtiExplainTitle"></b>
<div class="muted" id="mbtiExplainText" style="margin-top:6px;"></div>
</div>
<div class="hint" id="mbtiHint">æœªé€‰æ‹©</div>
<input id="mbti" type="hidden" value=""/>
</div>
<!-- å†³ç­–ä¸»é¢˜ï¼ˆchipsï¼‰ + æ¨¡æ¿ + å†³ç­–éš¾é¢˜ï¼ˆä¿ç•™ï¼‰ -->
<div class="form-group">
<label>å†³ç­–ä¸»é¢˜ï¼ˆå¯é€‰ï¼‰</label>
<div class="chip-group" id="problemCats"></div>
<p class="hint">å…ˆé€‰ä¸»é¢˜ â†’ ä¼šå‡ºç°â€œå¸¸è§æ¨¡æ¿â€ï¼›ä¹Ÿå¯ç›´æ¥å†™ä¸‹æ–¹â€œå†³ç­–éš¾é¢˜â€ã€‚</p>
</div>
<div class="form-group" id="problemTemplatesWrap" style="display:none;">
<label>å¸¸è§é—®é¢˜æ¨¡æ¿ï¼ˆé€‰å…¶ä¸€ï¼Œå¯è‡ªåŠ¨ç”Ÿæˆéª¨æ¶ï¼‰</label>
<div class="chip-group" id="problemTemplates"></div>
</div>
<div class="form-group">
<label for="problem">é‡åˆ°çš„å†³ç­–éš¾é¢˜ï¼ˆå¯é€‰ï¼‰</label>
<textarea id="problem" placeholder="ä¸æƒ³å†™å¯ç•™ç©ºï¼›é€‰æ¨¡æ¿åä¼šè‡ªåŠ¨å¡«å…¥éª¨æ¶ï¼Œä½ åªéœ€è¡¥å…³é”®ç‚¹" rows="4"></textarea>
</div>
<!-- æ€§æ ¼æ ‡ç­¾ + è¡¥å……ï¼ˆä¿ç•™ï¼‰ -->
<div class="form-group">
<label>æ€§æ ¼æ ‡ç­¾ï¼ˆå¯å¤šé€‰ï¼Œå¯é€‰ï¼‰</label>
<div class="chip-group" id="personalityChips"></div>
</div>
<div class="form-group">
<label for="personality">æ€§æ ¼è¡¥å……ï¼ˆå¯é€‰ï¼‰</label>
<textarea id="personality" placeholder="è‹¥æ ‡ç­¾ä¸è¶³ä»¥è¡¨è¾¾ï¼Œå†è¡¥å……å‡ å¥" rows="3"></textarea>
</div>
<!-- ä¸ªäººèƒŒæ™¯æ ‡ç­¾ + è¡¥å……ï¼ˆä¿ç•™ï¼‰ -->
<div class="form-group">
<label>ä¸ªäººèƒŒæ™¯ï¼ˆå¯å¤šé€‰ï¼Œå¯é€‰ï¼‰</label>
<div class="chip-group" id="bgChips"></div>
</div>
<div class="form-group">
<label for="background">ä¸ªäººèƒŒæ™¯è¡¥å……ï¼ˆå¯é€‰ï¼‰</label>
<textarea id="background" placeholder="è¡¥å……å°‘é‡å…³é”®äº‹å®å³å¯" rows="3"></textarea>
</div>
</div>
<button id="nextStep1">ä¸‹ä¸€æ­¥</button>
</div>
<!-- æ­¥éª¤2: æ•…äº‹åœºæ™¯å’Œç¬¬ä¸€ä¸ªå†³ç­–ç‚¹ -->
<div class="step-container" id="step2">
<h2 class="step-title">ç¬¬äºŒæ­¥ï¼šæ•…äº‹åœºæ™¯</h2>
<p class="step-description">AIæ ¹æ®æ‚¨çš„ä¿¡æ¯åˆ›å»ºäº†ä¸€ä¸ªç›¸å…³æ•…äº‹åœºæ™¯ï¼Œè¯·åœ¨å…³é”®èŠ‚ç‚¹åšå‡ºé€‰æ‹©</p>
<div class="character-section">
<h3 class="character-title">æ‚¨çš„è§’è‰²æ¡£æ¡ˆ</h3>
<div id="characterBadges">
<!-- è§’è‰²ä¿¡æ¯å¾½ç« å°†ç”±JavaScriptåŠ¨æ€ç”Ÿæˆ -->
</div>
</div>
<div class="story-image">ğŸ“–</div>
<div class="story-section" id="storySection1">
<div class="story-title">æ•…äº‹èƒŒæ™¯</div>
<div id="storyContent1">æ•…äº‹å†…å®¹åŠ è½½ä¸­...</div>
</div>
<div class="options-container" id="decisionOptions1">
<!-- é€‰é¡¹å°†ç”±JavaScriptåŠ¨æ€ç”Ÿæˆ -->
</div>
<div class="nav-buttons">
<button class="nav-btn back-btn" id="backStep2">ä¸Šä¸€æ­¥</button>
<button class="nav-btn" disabled="" id="nextStep2">ä¸‹ä¸€æ­¥</button>
</div>
</div>
<!-- æ­¥éª¤3: ç¬¬äºŒä¸ªå†³ç­–ç‚¹ -->
<div class="step-container" id="step3">
<h2 class="step-title">ç¬¬ä¸‰æ­¥ï¼šæ•…äº‹å‘å±•</h2>
<p class="step-description">æ•…äº‹ç»§ç»­å‘å±•ï¼Œè¯·åšå‡ºä¸‹ä¸€ä¸ªé‡è¦å†³ç­–</p>
<div class="choice-result" id="choiceResult1">
<div class="choice-title">æ‚¨ä¸Šæ¬¡çš„é€‰æ‹©</div>
<div id="choiceContent1">é€‰æ‹©ç»“æœåŠ è½½ä¸­...</div>
</div>
<div class="story-image">ğŸŒ…</div>
<div class="story-section" id="storySection2">
<div class="story-title">æ•…äº‹ç»§ç»­</div>
<div id="storyContent2">æ•…äº‹å†…å®¹åŠ è½½ä¸­...</div>
</div>
<div class="options-container" id="decisionOptions2">
<!-- é€‰é¡¹å°†ç”±JavaScriptåŠ¨æ€ç”Ÿæˆ -->
</div>
<div class="nav-buttons">
<button class="nav-btn back-btn" id="backStep3">ä¸Šä¸€æ­¥</button>
<button class="nav-btn" disabled="" id="nextStep3">ä¸‹ä¸€æ­¥</button>
</div>
</div>
<!-- æ­¥éª¤4: ç¬¬ä¸‰ä¸ªå†³ç­–ç‚¹ -->
<div class="step-container" id="step4">
<h2 class="step-title">ç¬¬å››æ­¥ï¼šæœ€ç»ˆå†³ç­–</h2>
<p class="step-description">æ•…äº‹æ¥è¿‘å°¾å£°ï¼Œè¯·åšå‡ºæœ€ç»ˆå†³ç­–</p>
<div class="choice-result" id="choiceResult2">
<div class="choice-title">æ‚¨ä¸Šæ¬¡çš„é€‰æ‹©</div>
<div id="choiceContent2">é€‰æ‹©ç»“æœåŠ è½½ä¸­...</div>
</div>
<div class="story-image">âš¡</div>
<div class="story-section" id="storySection3">
<div class="story-title">æ•…äº‹é«˜æ½®</div>
<div id="storyContent3">æ•…äº‹å†…å®¹åŠ è½½ä¸­...</div>
</div>
<div class="options-container" id="decisionOptions3">
<!-- é€‰é¡¹å°†ç”±JavaScriptåŠ¨æ€ç”Ÿæˆ -->
</div>
<div class="nav-buttons">
<button class="nav-btn back-btn" id="backStep4">ä¸Šä¸€æ­¥</button>
<button class="nav-btn" disabled="" id="nextStep4">ä¸‹ä¸€æ­¥</button>
</div>
</div>
<!-- æ­¥éª¤5: ç»“æœåˆ†æ -->
<div class="step-container" id="step5">
<h2 class="step-title">ç¬¬äº”æ­¥ï¼šå†³ç­–ç»“æœåˆ†æ</h2>
<p class="step-description">AIæ­£åœ¨åˆ†ææ‚¨çš„å†³ç­–è·¯å¾„å’Œå¯èƒ½ç»“æœ...</p>
<div class="choice-result" id="choiceResult3">
<div class="choice-title">æ‚¨ä¸Šæ¬¡çš„é€‰æ‹©</div>
<div id="choiceContent3">é€‰æ‹©ç»“æœåŠ è½½ä¸­...</div>
</div>
<div class="loading" id="loading">
<div class="spinner"></div>
<p style="text-align: center; margin-top: 15px;">AIæ­£åœ¨åˆ†ææ‚¨çš„å†³ç­–è·¯å¾„...</p>
</div>
<div class="result-section" id="resultSection">
<h2 class="result-title">æ‚¨çš„å†³ç­–è·¯å¾„åˆ†æ</h2>
<div class="result-content" id="resultContent"></div>
<div class="consequence-section" id="consequenceSection">
<div class="consequence-title">é•¿æœŸå½±å“å’Œæœªæ¥å‘å±•</div>
<div id="consequenceContent"></div>
</div>
<div class="life-review-section" id="lifeReviewSection">
<div class="life-review-title">å›çœ‹äººç”Ÿï¼šå†³ç­–å›é¡¾</div>
<div id="lifeReviewContent"></div>
</div>

                
                <div class="ending-section" id="endingSection">
                    <div class="ending-title">æœ€ç»ˆç»“å±€</div>
                    <div id="endingContent"></div>
                </div>
<div class="reflection-questions" id="reflectionSection">
<div class="reflection-title">åæ€ä¸å­¦ä¹ </div>
<div id="reflectionContent"></div>
</div>
</div>
<div class="nav-buttons">
<button class="nav-btn back-btn" id="backStep5">ä¸Šä¸€æ­¥</button>
<button class="nav-btn" id="restartBtn" style="display:none;">é‡æ–°å¼€å§‹</button>
</div>
</div>
<p class="disclaimer">æ¸©é¦¨æç¤ºï¼šæœ¬å·¥å…·æ—¨åœ¨é€šè¿‡æ•…äº‹å¸®åŠ©æ‚¨æ¢ç´¢å†³ç­–å¯èƒ½å¸¦æ¥çš„ç»“æœï¼Œå®é™…å†³ç­–è¯·ç»“åˆå…·ä½“æƒ…å†µ</p>
</div>
<script>
        // çŠ¶æ€ç®¡ç†
        const state = {
            currentStep: 1,
            totalSteps: 5,
            userSelections: {
                name: '',
                age: '',
                profession: '',
                personality: '',
                background: '',
                mbti: '',
                problem: '',
                decisions: []
            }
        };

        // åˆå§‹åŒ–æ­¥éª¤æŒ‡ç¤ºå™¨
        function initStepIndicators() {
            const container = document.getElementById('stepIndicators');
            container.innerHTML = '';
            
            for (let i = 1; i <= state.totalSteps; i++) {
                const indicator = document.createElement('div');
                indicator.className = `step-indicator ${i === state.currentStep ? 'active' : ''}`;
                indicator.setAttribute('data-step', i);
                container.appendChild(indicator);
            }
        }

        // æ›´æ–°è¿›åº¦æ¡
        function updateProgressBar() {
            const progress = ((state.currentStep - 1) / (state.totalSteps - 1)) * 100;
            document.getElementById('progressBar').style.width = `${progress}%`;
        }

        // åˆ‡æ¢æ­¥éª¤
        function goToStep(step) {
            // éšè—æ‰€æœ‰æ­¥éª¤
            document.querySelectorAll('.step-container').forEach(container => {
                container.classList.remove('active');
            });
            
            // æ˜¾ç¤ºç›®æ ‡æ­¥éª¤
            document.getElementById(`step${step}`).classList.add('active');
            
            // æ›´æ–°å½“å‰æ­¥éª¤
            state.currentStep = step;
            
            // æ›´æ–°æ­¥éª¤æŒ‡ç¤ºå™¨
            document.querySelectorAll('.step-indicator').forEach((indicator, index) => {
                if (index + 1 === step) {
                    indicator.classList.add('active');
                } else {
                    indicator.classList.remove('active');
                }
            });
            
            // æ›´æ–°è¿›åº¦æ¡
            updateProgressBar();
        }

        // éªŒè¯æ­¥éª¤1
        
const $=id=>document.getElementById(id);
/* ====== æ•°æ®æ± ï¼ˆç¬¬1é¡µï¼‰ ====== */
    const problemCats=["èŒä¸š","å­¦ä¸š","ç§‘ç ”æŠ•ç¨¿","å›¢é˜Ÿç®¡ç†","é¡¹ç›®é€‰æ‹©","è´¢åŠ¡","å¥åº·","æ„Ÿæƒ…","å…¶ä»–"];
    const categoryTemplates={
      "èŒä¸š":["æ˜¯å¦è·³æ§½","è¯»åšè¿˜æ˜¯å·¥ä½œ","è½¬è¡Œå¯è¡Œæ€§","å‡èŒ vs è½¬å²—"],
      "å­¦ä¸š":["è€ƒç ”/è¯»åšé€‰æ‹©","æ¢å¯¼å¸ˆ/æ¢è¯¾é¢˜","å‡ºå›½äº¤æ¢"],
      "ç§‘ç ”æŠ•ç¨¿":["ç»§ç»­å¤§ä¿®è¿˜æ˜¯è½¬æŠ•","ä¸€ç¯‡æ‹†ä¸¤ç¯‡","æ‰¾åˆä½œè¡¥å®éªŒ"],
      "å›¢é˜Ÿç®¡ç†":["é‡å»ºåä½œè§„åˆ™","ç»©æ•ˆä¸æ¿€åŠ±æ–¹æ¡ˆ","å¼•å…¥æ–°äººæˆ–å¤–åŒ…"],
      "é¡¹ç›®é€‰æ‹©":["é«˜é£é™©é«˜å›æŠ¥é¡¹ç›®","ç¨³å¦¥ä¿åº•é¡¹ç›®","å¹¶è¡Œä¸¤æ¡çº¿"],
      "è´¢åŠ¡":["ç»§ç»­å­¦ä¹ æŠ•èµ„/å®šæŠ•","åˆ›ä¸šæŠ•å…¥/ä¿å®ˆç†è´¢"],
      "å¥åº·":["ä½œæ¯é‡å»º","è¿åŠ¨ä¸é¥®é£Ÿè®¡åˆ’"],
      "æ„Ÿæƒ…":["å¼‚åœ°/åŒåŸæƒè¡¡","ç»“å©šä¸è¿›ä¿®å®‰æ’"],
      "å…¶ä»–":["è‡ªå®šä¹‰é—®é¢˜éª¨æ¶"]
    };
    const personalityPool=["å†…å‘","å¤–å‘","ç†æ€§","æ„Ÿæ€§","è°¨æ…","å–œæ¬¢å†’é™©","ç»“æœå¯¼å‘","è¿‡ç¨‹å¯¼å‘","å®Œç¾ä¸»ä¹‰","åŒç†å¿ƒå¼º","åˆ›é€ åŠ›å¼º","æŠ—å‹å¥½"];
    const bgPool=["åœ¨æ ¡ç”Ÿ","åº”å±Š","1â€“3å¹´ç»éªŒ","3â€“5å¹´ç»éªŒ","5â€“10å¹´ç»éªŒ","ç§‘ç ”æ–¹å‘","äº’è”ç½‘è¡Œä¸š","åŒ»ç–—å¥åº·","æ•™è‚²è¡Œä¸š","å·²å©š/æœ‰å­©","èµ¡å…»çˆ¶æ¯","æµ·å¤–å±…ä½"];

    const rolesMap={
      "IT/äº’è”ç½‘":["åç«¯å·¥ç¨‹å¸ˆ","å‰ç«¯å·¥ç¨‹å¸ˆ","ç§»åŠ¨å¼€å‘","å…¨æ ˆå·¥ç¨‹å¸ˆ","æµ‹è¯•/QA","è¿ç»´/DevOps","æ¶æ„å¸ˆ","æ•°æ®åˆ†æå¸ˆ","æ•°æ®å·¥ç¨‹å¸ˆ","ç®—æ³•å·¥ç¨‹å¸ˆ","äº§å“ç»ç†","é¡¹ç›®ç»ç†","ç”¨æˆ·è¿è¥","å†…å®¹è¿è¥","å¢é•¿è¿è¥","UI/UXè®¾è®¡","å®‰å…¨å·¥ç¨‹å¸ˆ","å”®å‰/å”®åæŠ€æœ¯æ”¯æŒ"],
      "é‡‘è/é“¶è¡Œ/ä¿é™©":["æŠ•èµ„ç»ç†","æŠ•ç ”/ç ”ç©¶å‘˜","é‡åŒ–ç ”ç©¶","é£æ§","å®¡è®¡","ç†è´¢é¡¾é—®","è¯åˆ¸/åŸºé‡‘/æœŸè´§","ä¿¡è´·","ç²¾ç®—","äº¤æ˜“å‘˜","åˆè§„","é‡‘èIT"],
      "æ•™è‚²/åŸ¹è®­/é«˜æ ¡":["è€å¸ˆ/è®²å¸ˆ","æ•™ç ”","æ•™åŠ¡/ç­ä¸»ä»»","è¯¾ç¨‹é¡¾é—®","åŸ¹è®­è®²å¸ˆ","è¾…å¯¼å‘˜","å®éªŒå‘˜","ç§‘ç ”åŠ©ç†/åšå£«å"],
      "åŒ»ç–—/åˆ¶è¯/ç”Ÿç‰©":["åŒ»ç”Ÿ","æŠ¤å£«","è¯å¸ˆ","åŒ»æŠ€/æ£€éªŒ","åŒ»ç–—ç®¡ç†","åŒ»è¯ä»£è¡¨","ä¸´åºŠè¯•éªŒ/CRA","åŒ»ç–—å™¨æ¢°å·¥ç¨‹å¸ˆ","å…¬å«/æµè°ƒ"],
      "åˆ¶é€ /å·¥ä¸š/æ±½è½¦":["æœºæ¢°å·¥ç¨‹å¸ˆ","ç”µæ°”å·¥ç¨‹å¸ˆ","å·¥è‰ºå·¥ç¨‹å¸ˆ","è´¨é‡/è´¨æ£€","ç”Ÿäº§ç®¡ç†","è®¾å¤‡å·¥ç¨‹å¸ˆ","ä¾›åº”é“¾è®¡åˆ’","é‡‡è´­","EHS","ç ”å‘å·¥ç¨‹å¸ˆ","å·¥ä¸šè½¯ä»¶/MES"],
      "èƒ½æº/åŒ–å·¥/çŸ¿ä¸š":["åŒ–å·¥/å·¥è‰ºå·¥ç¨‹å¸ˆ","è®¾å¤‡/ç®¡é“å·¥ç¨‹å¸ˆ","ç°åœº/é¡¹ç›®å·¥ç¨‹å¸ˆ","å‹˜æ¢/åœ°è´¨","è¿è¥/è°ƒåº¦","å®‰å…¨å·¥ç¨‹å¸ˆ"],
      "å»ºç­‘/å·¥ç¨‹/æˆ¿åœ°äº§":["ç»“æ„/åœŸæœ¨å·¥ç¨‹å¸ˆ","å»ºç­‘è®¾è®¡","é€ ä»·/é¢„ç®—","æ–½å·¥ç»ç†","ç›‘ç†","BIMå·¥ç¨‹å¸ˆ","åœ°äº§å¼€å‘/ç­–åˆ’","ç‰©ä¸šç®¡ç†","åŸå¸‚è§„åˆ’"],
      "äº¤é€š/ç‰©æµ/ä¾›åº”é“¾":["ç‰©æµè¿è¥","ä»“å‚¨ç®¡ç†","è¿è¾“è°ƒåº¦","æµ·å¤–ç‰©æµ","å…³åŠ¡/æŠ¥å…³","ä¾›åº”é“¾ç®¡ç†","é‡‡è´­","è½¦é˜Ÿç®¡ç†"],
      "é›¶å”®/ç”µå•†/å¿«æ¶ˆ":["é—¨åº—åº—é•¿/åº—å‘˜","ç”µå•†è¿è¥","æ–°åª’ä½“/å†…å®¹è¿è¥","å“ç‰Œ/å¸‚åœº","é”€å”®/æ¸ é“","å•†å“ä¼åˆ’","å®¢æœ","é‡‡è´­/å•†å“","æ•°æ®åˆ†æ"],
      "æ–‡å¨±/ä¼ åª’/æ¸¸æˆ":["ç­–åˆ’/ç¼–è¾‘","è®°è€…/ç¼–å¯¼","æ‘„å½±/åæœŸ","å‘è¡Œ/å®£å‘","PR/å…¬å…³","è¿è¥","ç¾æœ¯/åŠ¨æ•ˆ","é…éŸ³/å£°éŸ³"],
      "æ³•å¾‹/å’¨è¯¢/ä¼šè®¡":["å¾‹å¸ˆ","æ³•åŠ¡","ç¨åŠ¡","å®¡è®¡","ä¼šè®¡","å’¨è¯¢é¡¾é—®(ç®¡ç†/IT/æˆ˜ç•¥/äººåŠ›)"],
      "æ”¿åºœ/å…¬å…±äº‹ä¸š/äº‹ä¸šå•ä½":["å…¬åŠ¡å‘˜","äº‹ä¸šå•ä½èŒå‘˜","ç¤¾å·¥","è¡Œæ”¿ç®¡ç†","ç§‘æ™®/ç§‘æ•™","ç§‘ç ”é™¢æ‰€ç ”ç©¶å‘˜"],
      "å†œä¸š/ç¯ä¿/æ–°èƒ½æº":["å†œè‰ºå¸ˆ","æ—ä¸š/æ¸”ä¸š","ç¯ä¿å·¥ç¨‹å¸ˆ","ç¢³ç®¡ç†/ESG","å…‰ä¼å·¥ç¨‹å¸ˆ","é£ç”µå·¥ç¨‹å¸ˆ","å‚¨èƒ½å·¥ç¨‹å¸ˆ"],
      "æ—…æ¸¸/é…’åº—/é¤é¥®":["é…’åº—ç®¡ç†","å‰å°/ç¤¼å®¾","æ—…è¡Œé¡¾é—®","å¯¼æ¸¸","å¨å¸ˆ/åå¨","é¤é¥®åº—é•¿"],
      "éè¥åˆ©/å…¬ç›Š":["é¡¹ç›®å®˜å‘˜/ç»ç†","ç­¹æ¬¾","ä¼ æ’­","ç›‘æµ‹è¯„ä¼°"],
      "è‡ªç”±èŒä¸š/ä¸ªä½“":["è‡ªåª’ä½“/åˆ›ä½œè€…","è®¾è®¡æ¥æ¡ˆ","ç¨‹åºæ¥æ¡ˆ","ç‹¬ç«‹é¡¾é—®","åˆ›ä¸šè€…"],
      "å…¶ä»–":["å…¶ä»–ï¼ˆè¯·å¡«å†™ï¼‰"]
    };

    const mbtiExplain={
      ISTJ:"å†…å‘ã€æ³¨é‡å®æ„Ÿã€æ€ç»´ä¸»å¯¼ã€åˆ¤æ–­å‹", ISFJ:"å†…å‘ã€æ³¨é‡å®æ„Ÿã€æƒ…æ„Ÿä¸»å¯¼ã€åˆ¤æ–­å‹",
      INFJ:"å†…å‘ã€ç›´è§‰ä¸»å¯¼ã€æƒ…æ„Ÿä¸»å¯¼ã€åˆ¤æ–­å‹", INTJ:"å†…å‘ã€ç›´è§‰ä¸»å¯¼ã€æ€ç»´ä¸»å¯¼ã€åˆ¤æ–­å‹",
      ISTP:"å†…å‘ã€æ³¨é‡å®æ„Ÿã€æ€ç»´ä¸»å¯¼ã€æ„ŸçŸ¥å‹", ISFP:"å†…å‘ã€æ³¨é‡å®æ„Ÿã€æƒ…æ„Ÿä¸»å¯¼ã€æ„ŸçŸ¥å‹",
      INFP:"å†…å‘ã€ç›´è§‰ä¸»å¯¼ã€æƒ…æ„Ÿä¸»å¯¼ã€æ„ŸçŸ¥å‹", INTP:"å†…å‘ã€ç›´è§‰ä¸»å¯¼ã€æ€ç»´ä¸»å¯¼ã€æ„ŸçŸ¥å‹",
      ESTP:"å¤–å‘ã€æ³¨é‡å®æ„Ÿã€æ€ç»´ä¸»å¯¼ã€æ„ŸçŸ¥å‹", ESFP:"å¤–å‘ã€æ³¨é‡å®æ„Ÿã€æƒ…æ„Ÿä¸»å¯¼ã€æ„ŸçŸ¥å‹",
      ENFP:"å¤–å‘ã€ç›´è§‰ä¸»å¯¼ã€æƒ…æ„Ÿä¸»å¯¼ã€æ„ŸçŸ¥å‹", ENTP:"å¤–å‘ã€ç›´è§‰ä¸»å¯¼ã€æ€ç»´ä¸»å¯¼ã€æ„ŸçŸ¥å‹",
      ESTJ:"å¤–å‘ã€æ³¨é‡å®æ„Ÿã€æ€ç»´ä¸»å¯¼ã€åˆ¤æ–­å‹", ESFJ:"å¤–å‘ã€æ³¨é‡å®æ„Ÿã€æƒ…æ„Ÿä¸»å¯¼ã€åˆ¤æ–­å‹",
      ENFJ:"å¤–å‘ã€ç›´è§‰ä¸»å¯¼ã€æƒ…æ„Ÿä¸»å¯¼ã€åˆ¤æ–­å‹", ENTJ:"å¤–å‘ã€ç›´è§‰ä¸»å¯¼ã€æ€ç»´ä¸»å¯¼ã€åˆ¤æ–­å‹"
    };
    const mbtiOrder=["ISTJ","ISFJ","INFJ","INTJ","ISTP","ISFP","INFP","INTP","ESTP","ESFP","ENFP","ENTP","ESTJ","ESFJ","ENFJ","ENTJ"];

    
/* ====== å°å·¥å…· ====== */
    function bindChips(containerId,{multiple=true,onChange}){
      const c=$(containerId);
      c.addEventListener('click',e=>{
        const t=e.target.closest('.chip'); if(!t) return;
        if(!multiple){[...c.querySelectorAll('.chip')].forEach(n=>n.classList.remove('selected')); t.classList.add('selected');}
        else{t.classList.toggle('selected');}
        onChange && onChange([...c.querySelectorAll('.chip.selected')].map(n=>n.dataset.value||n.dataset.type||n.textContent));
      });
    }
    const selectedTexts=id=>[...$(id).querySelectorAll('.chip.selected')].map(n=>n.dataset.value||n.dataset.type||n.textContent);
    function updateMBTIExplain(v){
      if(v && mbtiExplain[v]){ $('mbtiExplainWrap').style.display='block'; $('mbtiExplainTitle').textContent=`${v} ç±»å‹è¯´æ˜`; $('mbtiExplainText').textContent=mbtiExplain[v]; $('mbtiHint').textContent=`å·²é€‰æ‹©ï¼š${v}`; }
      else { $('mbtiExplainWrap').style.display='none'; $('mbtiExplainTitle').textContent=''; $('mbtiExplainText').textContent=''; $('mbtiHint').textContent='æœªé€‰æ‹©'; }
    }

    /* ====== æ ¡éªŒï¼šä»…å§“å & å¹´é¾„å¿…å¡« ====== */
    
function validateStep1(){
      const name=$('name').value.trim();
      const age=$('age').value.trim();
      if(!name){alert('è¯·å¡«å†™å§“å');return false;}
      if(!age){alert('è¯·å¡«å†™å¹´é¾„');return false;}

      // æ±‡æ€»å¯é€‰é¡¹
      state.userSelections.name=name;
      state.userSelections.age=age;
      state.userSelections.profession=$('profession').value.trim();
      state.userSelections.personality=$('personality').value.trim() || selectedTexts('personalityChips').join('ã€');
      state.userSelections.background=$('background').value.trim() || selectedTexts('bgChips').join('ã€');
      state.userSelections.mbti=$('mbti').value.trim();
      state.userSelections.problem=$('problem').value.trim();
      return true;
    }

        // æ˜¾ç¤ºè§’è‰²å¾½ç« 
        function displayCharacterBadges() {
            const badgesContainer = document.getElementById('characterBadges');
            badgesContainer.innerHTML = '';
            
            const { name, age, profession, personality, mbti } = state.userSelections;
            
            if (name) {
                const badge = document.createElement('span');
                badge.className = 'character-badge';
                badge.textContent = `å§“å: ${name}`;
                badgesContainer.appendChild(badge);
            }
            
            if (age) {
                const badge = document.createElement('span');
                badge.className = 'character-badge';
                badge.textContent = `å¹´é¾„: ${age}`;
                badgesContainer.appendChild(badge);
            }
            
            if (profession) {
                const badge = document.createElement('span');
                badge.className = 'character-badge';
                badge.textContent = `èŒä¸š: ${profession}`;
                badgesContainer.appendChild(badge);
            }
            
            if (mbti) {
                const badge = document.createElement('span');
                badge.className = 'character-badge';
                badge.textContent = `MBTI: ${mbti}`;
                badgesContainer.appendChild(badge);
            }
            
            if (personality) {
                const badge = document.createElement('span');
                badge.className = 'character-badge';
                badge.textContent = `æ€§æ ¼: ${personality}`;
                badgesContainer.appendChild(badge);
            }
        }

        // æ˜¾ç¤ºåŠ è½½å±‚
        function showLoading(message = 'å¤„ç†ä¸­...') {
            const overlay = document.createElement('div');
            overlay.className = 'loading-overlay';
            overlay.innerHTML = `
                <div style="text-align: center;">
                    <div class="spinner"></div>
                    <p>${message}</p>
                </div>
            `;
            document.body.appendChild(overlay);
        }

        // éšè—åŠ è½½å±‚
        function hideLoading() {
            const overlay = document.querySelector('.loading-overlay');
            if (overlay) {
                overlay.remove();
            }
        }

        // ç”Ÿæˆç¬¬ä¸€ä¸ªæ•…äº‹åœºæ™¯å’Œå†³ç­–ç‚¹
        async function generateFirstStory() {
            const storyContent = document.getElementById('storyContent1');
            storyContent.innerHTML = 'æ­£åœ¨ç”Ÿæˆæ•…äº‹åœºæ™¯...';
            
            const optionsContainer = document.getElementById('decisionOptions1');
            optionsContainer.innerHTML = '';
            
            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            document.getElementById('nextStep2').disabled = true;
            document.getElementById('nextStep2').textContent = 'ç”Ÿæˆæ•…äº‹ä¸­...';
            
            try {
                // æ„å»ºæç¤ºè¯ - å¼ºè°ƒæ•…äº‹æ€§å’Œæ²‰æµ¸æ„Ÿ
                const prompt = `ç”¨æˆ·ä¿¡æ¯ï¼š
å§“åï¼š${state.userSelections.name}
å¹´é¾„ï¼š${state.userSelections.age}
èŒä¸šï¼š${state.userSelections.profession}
æ€§æ ¼ï¼š${state.userSelections.personality}
ä¸ªäººèƒŒæ™¯ï¼š${state.userSelections.background}
MBTIï¼š${state.userSelections.mbti}
å†³ç­–éš¾é¢˜ï¼š${state.userSelections.problem}

è¯·æ ¹æ®ä»¥ä¸Šä¿¡æ¯ï¼Œåˆ›å»ºä¸€ä¸ªä¸ç”¨æˆ·æƒ…å†µç›¸å…³çš„æ²‰æµ¸å¼è™šæ„æ•…äº‹åœºæ™¯ã€‚æ•…äº‹åº”è¯¥ï¼š
1. åæ˜ ç”¨æˆ·é¢ä¸´çš„å†³ç­–éš¾é¢˜ï¼Œèå…¥ç”¨æˆ·çš„ä¸ªäººä¿¡æ¯ï¼ˆå§“åã€å¹´é¾„ã€èŒä¸šã€æ€§æ ¼ã€MBTIã€ä¸ªäººèƒŒæ™¯ï¼‰
2. åˆ›å»ºç”ŸåŠ¨ã€è¯¦ç»†çš„åœºæ™¯æè¿°ï¼Œè®©ç”¨æˆ·æœ‰èº«ä¸´å…¶å¢ƒçš„æ„Ÿè§‰
3. åœ¨æ•…äº‹ä¸­è®¾ç½®ä¸€ä¸ªå…³é”®å†³ç­–ç‚¹
4. æä¾›2-3ä¸ªä¸åŒçš„é€‰æ‹©é€‰é¡¹ï¼Œç¡®ä¿æ¯ä¸ªé€‰é¡¹éƒ½æœ‰æ˜æ˜¾åŒºåˆ«ä¸”ç¬¦åˆç”¨æˆ·æ€§æ ¼ç‰¹ç‚¹
5. è€ƒè™‘ä¸åŒé€‰é¡¹å¯èƒ½å¯¼è‡´çš„ä¸åŒç»“æœï¼ŒåŒ…æ‹¬å¯èƒ½çš„å¤±è´¥æˆ–æŒ‘æˆ˜

è¯·ä»¥JSONæ ¼å¼è¿”å›ï¼Œæ ¼å¼å¦‚ä¸‹ï¼š
{
  "story": "ç”ŸåŠ¨è¯¦ç»†çš„æ•…äº‹æ–‡æœ¬ï¼ŒåŒ…å«æ„Ÿå®˜æè¿°å’Œæƒ…æ„Ÿå…ƒç´ ",
  "options": [
    {
      "title": "é€‰é¡¹1æ ‡é¢˜",
      "description": "é€‰é¡¹1è¯¦ç»†æè¿°",
      "risk_level": "é«˜/ä¸­/ä½"
    },
    {
      "title": "é€‰é¡¹2æ ‡é¢˜",
      "description": "é€‰é¡¹2è¯¦ç»†æè¿°",
      "risk_level": "é«˜/ä¸­/ä½"
    }
  ]
}`;

                // è°ƒç”¨DeepSeek API
                showLoading('æ­£åœ¨ç”Ÿæˆæ•…äº‹åœºæ™¯...');
                const response = await fetch('https://api.deepseek.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer sk-c61b75f2cf384e34ad46cb180978c848'
                    },
                    body: JSON.stringify({
                        model: 'deepseek-chat',
                        messages: [
                            {
                                role: 'system',
                                content: 'ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„æ²‰æµ¸å¼æ•…äº‹åˆ›ä½œè€…å’Œå†³ç­–åˆ†æåŠ©æ‰‹ï¼Œæ“…é•¿åˆ›å»ºä¸ç°å®ç”Ÿæ´»ç›¸å…³çš„ç”ŸåŠ¨æ•…äº‹åœºæ™¯ï¼Œå¸®åŠ©ç”¨æˆ·æ¢ç´¢ä¸åŒå†³ç­–çš„å¯èƒ½ç»“æœã€‚è¯·ç¡®ä¿æ•…äº‹ç”ŸåŠ¨ã€è¯¦ç»†ã€å¼•äººå…¥èƒœï¼ŒåŒ…å«ä¸°å¯Œçš„æ„Ÿå®˜æè¿°å’Œæƒ…æ„Ÿå…ƒç´ ï¼Œè®©ç”¨æˆ·æœ‰èº«ä¸´å…¶å¢ƒçš„æ„Ÿè§‰ã€‚è€ƒè™‘ä¸åŒé€‰é¡¹å¯èƒ½å¸¦æ¥çš„æŒ‘æˆ˜å’Œå¤±è´¥ï¼Œè€Œä¸ä»…ä»…æ˜¯æˆåŠŸçš„ç»“æœã€‚'
                            },
                            {
                                role: 'user',
                                content: prompt
                            }
                        ],
                        temperature: 0.8,
                        max_tokens: 2000
                    })
                });
                
                if (!response.ok) {
                    throw new Error('APIè¯·æ±‚å¤±è´¥');
                }
                
                const data = await response.json();
                const content = data.choices[0].message.content;
                
                // å°è¯•è§£æJSON
                let storyData;
                try {
                    // å°è¯•æå–JSONéƒ¨åˆ†
                    const jsonMatch = content.match(/\{[\s\S]*\}/);
                    if (jsonMatch) {
                        storyData = JSON.parse(jsonMatch[0]);
                    } else {
                        // å¦‚æœæ— æ³•æå–JSONï¼Œä½¿ç”¨é»˜è®¤æ•…äº‹
                        storyData = {
                            story: `åœ¨ä¸€ä¸ªå¿™ç¢Œçš„${state.userSelections.profession}å·¥ä½œæ—¥ï¼Œ${state.userSelections.name}ååœ¨åŠå…¬æ¡Œå‰ï¼Œçª—å¤–æ˜¯åŸå¸‚çš„å–§åš£ã€‚æ¡Œä¸Šå †æ»¡äº†æ–‡ä»¶å’ŒæŠ¥å‘Šï¼Œç”µè„‘å±å¹•ä¸Šé—ªçƒç€æœªè¯»é‚®ä»¶ã€‚${state.userSelections.name}æ·±å¸ä¸€å£æ°”ï¼Œæ„Ÿå—åˆ°è‚©ä¸Šçš„å‹åŠ›ã€‚ä½œä¸ºä¸€ä¸ª${state.userSelections.age}å²çš„${state.userSelections.profession}ï¼Œ${state.userSelections.name}é¢ä¸´ç€ä¸€ä¸ªå…³é”®çš„èŒä¸šå†³ç­–ã€‚å›¢é˜Ÿæ­£åœ¨æ¨è¿›ä¸€ä¸ªé‡è¦çš„é¡¹ç›®ï¼Œä½†é‡åˆ°äº†æ„æƒ³ä¸åˆ°çš„æŒ‘æˆ˜ã€‚é¡¹ç›®è¿›åº¦è½åï¼Œé¢„ç®—ç´§å¼ ï¼Œå›¢é˜Ÿæˆå‘˜å£«æ°”ä½è½ã€‚${state.userSelections.name}çš„${state.userSelections.mbti}æ€§æ ¼è®©${state.userSelections.name}åœ¨å†³ç­–æ—¶ç‰¹åˆ«å…³æ³¨${state.userSelections.personality}ã€‚è¿™æ—¶ï¼Œ${state.userSelections.name}éœ€è¦å†³å®šå¦‚ä½•åº”å¯¹è¿™ç§æƒ…å†µã€‚`,
                            options: [
                                {
                                    title: "ä¿å®ˆç­–ç•¥",
                                    description: "ç¼©å‡é¡¹ç›®èŒƒå›´ï¼Œç¡®ä¿æ ¸å¿ƒåŠŸèƒ½æŒ‰æ—¶äº¤ä»˜ï¼Œé¿å…è¿›ä¸€æ­¥é£é™©",
                                    risk_level: "ä½"
                                },
                                {
                                    title: "ç§¯æåº”å¯¹",
                                    description: "ç”³è¯·é¢å¤–èµ„æºï¼ŒæŒ‰åŸè®¡åˆ’æ¨è¿›é¡¹ç›®ï¼Œå¯»æ±‚çªç ´æ€§è§£å†³æ–¹æ¡ˆ",
                                    risk_level: "é«˜"
                                }
                            ]
                        };
                    }
                } catch (e) {
                    // å¦‚æœè§£æå¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤æ•…äº‹
                    storyData = {
                        story: `åœ¨ä¸€ä¸ªå¿™ç¢Œçš„${state.userSelections.profession}å·¥ä½œæ—¥ï¼Œ${state.userSelections.name}ååœ¨åŠå…¬æ¡Œå‰ï¼Œçª—å¤–æ˜¯åŸå¸‚çš„å–§åš£ã€‚æ¡Œä¸Šå †æ»¡äº†æ–‡ä»¶å’ŒæŠ¥å‘Šï¼Œç”µè„‘å±å¹•ä¸Šé—ªçƒç€æœªè¯»é‚®ä»¶ã€‚${state.userSelections.name}æ·±å¸ä¸€å£æ°”ï¼Œæ„Ÿå—åˆ°è‚©ä¸Šçš„å‹åŠ›ã€‚ä½œä¸ºä¸€ä¸ª${state.userSelections.age}å²çš„${state.userSelections.profession}ï¼Œ${state.userSelections.name}é¢ä¸´ç€ä¸€ä¸ªå…³é”®çš„èŒä¸šå†³ç­–ã€‚å›¢é˜Ÿæ­£åœ¨æ¨è¿›ä¸€ä¸ªé‡è¦çš„é¡¹ç›®ï¼Œä½†é‡åˆ°äº†æ„æƒ³ä¸åˆ°çš„æŒ‘æˆ˜ã€‚é¡¹ç›®è¿›åº¦è½åï¼Œé¢„ç®—ç´§å¼ ï¼Œå›¢é˜Ÿæˆå‘˜å£«æ°”ä½è½ã€‚${state.userSelections.name}çš„${state.userSelections.mbti}æ€§æ ¼è®©${state.userSelections.name}åœ¨å†³ç­–æ—¶ç‰¹åˆ«å…³æ³¨${state.userSelections.personality}ã€‚è¿™æ—¶ï¼Œ${state.userSelections.name}éœ€è¦å†³å®šå¦‚ä½•åº”å¯¹è¿™ç§æƒ…å†µã€‚`,
                        options: [
                            {
                                title: "ä¿å®ˆç­–ç•¥",
                                description: "ç¼©å‡é¡¹ç›®èŒƒå›´ï¼Œç¡®ä¿æ ¸å¿ƒåŠŸèƒ½æŒ‰æ—¶äº¤ä»˜ï¼Œé¿å…è¿›ä¸€æ­¥é£é™©",
                                risk_level: "ä½"
                            },
                            {
                                title: "ç§¯æåº”å¯¹",
                                description: "ç”³è¯·é¢å¤–èµ„æºï¼ŒæŒ‰åŸè®¡åˆ’æ¨è¿›é¡¹ç›®ï¼Œå¯»æ±‚çªç ´æ€§è§£å†³æ–¹æ¡ˆ",
                                risk_level: "é«˜"
                            }
                        ]
                    };
                }
                
                // æ›´æ–°æ•…äº‹å†…å®¹
                storyContent.innerHTML = storyData.story;
                
                // ç”Ÿæˆé€‰é¡¹å¡ç‰‡
                storyData.options.forEach((option, index) => {
                    const card = document.createElement('div');
                    card.className = 'option-card';
                    card.innerHTML = `
                        <div class="option-title">${option.title}</div>
                        <div class="option-description">${option.description}</div>
                        ${option.risk_level ? `<div class="risk-indicator" style="background-color: ${option.risk_level === 'é«˜' ? 'rgba(255, 107, 107, 0.3)' : option.risk_level === 'ä¸­' ? 'rgba(255, 167, 38, 0.3)' : 'rgba(102, 187, 106, 0.3)'}">é£é™©ç­‰çº§: ${option.risk_level}</div>` : ''}
                    `;
                    
                    card.addEventListener('click', () => {
                        // æ¸…é™¤å…¶ä»–é€‰é¡¹çš„é€‰æ‹©çŠ¶æ€
                        document.querySelectorAll('#decisionOptions1 .option-card').forEach(c => {
                            c.classList.remove('selected');
                        });
                        
                        // è®¾ç½®å½“å‰é€‰é¡¹ä¸ºé€‰ä¸­çŠ¶æ€
                        card.classList.add('selected');
                        
                        // ä¿å­˜é€‰æ‹©
                        state.userSelections.decisions[0] = {
                            title: option.title,
                            description: option.description,
                            risk_level: option.risk_level
                        };
                        
                        // å¯ç”¨ä¸‹ä¸€æ­¥æŒ‰é’®
                        document.getElementById('nextStep2').disabled = false;
                        document.getElementById('nextStep2').textContent = 'ä¸‹ä¸€æ­¥';
                    });
                    
                    optionsContainer.appendChild(card);
                });
                
            } catch (error) {
                console.error('APIè°ƒç”¨é”™è¯¯:', error);
                storyContent.innerHTML = 'ç”Ÿæˆæ•…äº‹æ—¶å‡ºç°é”™è¯¯ï¼Œè¯·ç¨åé‡è¯•ã€‚';
            } finally {
                hideLoading();
                document.getElementById('nextStep2').disabled = false;
                document.getElementById('nextStep2').textContent = 'ä¸‹ä¸€æ­¥';
            }
        }

        // ç”Ÿæˆç¬¬äºŒä¸ªæ•…äº‹åœºæ™¯å’Œå†³ç­–ç‚¹
        async function generateSecondStory() {
            const storyContent = document.getElementById('storyContent2');
            storyContent.innerHTML = 'æ­£åœ¨ç”Ÿæˆæ•…äº‹å‘å±•...';
            
            const choiceContent = document.getElementById('choiceContent1');
            choiceContent.innerHTML = `æ‚¨é€‰æ‹©äº†ï¼š${state.userSelections.decisions[0].title} - ${state.userSelections.decisions[0].description}`;
            
            const optionsContainer = document.getElementById('decisionOptions2');
            optionsContainer.innerHTML = '';
            
            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            document.getElementById('nextStep3').disabled = true;
            document.getElementById('nextStep3').textContent = 'ç”Ÿæˆæ•…äº‹ä¸­...';
            
            try {
                // æ„å»ºæç¤ºè¯ - å¼ºè°ƒæ•…äº‹æ€§å’Œæ²‰æµ¸æ„Ÿ
                const prompt = `ç”¨æˆ·ä¿¡æ¯ï¼š
å§“åï¼š${state.userSelections.name}
å¹´é¾„ï¼š${state.userSelections.age}
èŒä¸šï¼š${state.userSelections.profession}
æ€§æ ¼ï¼š${state.userSelections.personality}
ä¸ªäººèƒŒæ™¯ï¼š${state.userSelections.background}
MBTIï¼š${state.userSelections.mbti}
å†³ç­–éš¾é¢˜ï¼š${state.userSelections.problem}

ç”¨æˆ·åœ¨ä¸Šä¸€ä¸ªå†³ç­–ç‚¹é€‰æ‹©äº†ï¼š${state.userSelections.decisions[0].title} - ${state.userSelections.decisions[0].description}

è¯·æ ¹æ®ç”¨æˆ·çš„é€‰æ‹©ï¼Œç»§ç»­å‘å±•æ•…äº‹ã€‚æ•…äº‹åº”è¯¥ï¼š
1. é¦–å…ˆæè¿°ç”¨æˆ·é€‰æ‹©å¸¦æ¥çš„ç›´æ¥ç»“æœå’Œå½±å“ï¼ŒåŒ…æ‹¬å¯èƒ½çš„æŒ‘æˆ˜å’Œå¤±è´¥
2. ç„¶åç»§ç»­å‘å±•æ•…äº‹ï¼Œåˆ›å»ºæ–°çš„åœºæ™¯å’ŒæŒ‘æˆ˜
3. è®¾ç½®ä¸€ä¸ªæ–°çš„å…³é”®å†³ç­–ç‚¹
4. æä¾›2ä¸ªä¸åŒçš„é€‰æ‹©é€‰é¡¹ï¼Œç¡®ä¿é€‰é¡¹ä¹‹é—´æœ‰æ˜æ˜¾åŒºåˆ«ä¸”ç¬¦åˆç”¨æˆ·æ€§æ ¼ç‰¹ç‚¹
5. è€ƒè™‘ä¸åŒé€‰é¡¹å¯èƒ½å¯¼è‡´çš„ä¸åŒç»“æœï¼ŒåŒ…æ‹¬å¯èƒ½çš„å¤±è´¥æˆ–æŒ‘æˆ˜

è¯·ä»¥JSONæ ¼å¼è¿”å›ï¼Œæ ¼å¼å¦‚ä¸‹ï¼š
{
  "choiceResult": "ç”¨æˆ·é€‰æ‹©å¸¦æ¥çš„ç›´æ¥ç»“æœå’Œå½±å“æè¿°",
  "story": "æ–°åœºæ™¯çš„æ•…äº‹æ–‡æœ¬ï¼ŒåŒ…å«æ„Ÿå®˜æè¿°å’Œæƒ…æ„Ÿå…ƒç´ ",
  "options": [
    {
      "title": "é€‰é¡¹1æ ‡é¢˜",
      "description": "é€‰é¡¹1è¯¦ç»†æè¿°",
      "risk_level": "é«˜/ä¸­/ä½"
    },
    {
      "title": "é€‰é¡¹2æ ‡é¢˜",
      "description": "é€‰é¡¹2è¯¦ç»†æè¿°",
      "risk_level": "é«˜/ä¸­/ä½"
    }
  ]
}`;

                // è°ƒç”¨DeepSeek API
                showLoading('æ­£åœ¨ç”Ÿæˆæ•…äº‹å‘å±•...');
                const response = await fetch('https://api.deepseek.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer sk-c61b75f2cf384e34ad46cb180978c848'
                    },
                    body: JSON.stringify({
                        model: 'deepseek-chat',
                        messages: [
                            {
                                role: 'system',
                                content: 'ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„æ²‰æµ¸å¼æ•…äº‹åˆ›ä½œè€…å’Œå†³ç­–åˆ†æåŠ©æ‰‹ï¼Œæ“…é•¿åˆ›å»ºä¸ç°å®ç”Ÿæ´»ç›¸å…³çš„ç”ŸåŠ¨æ•…äº‹åœºæ™¯ï¼Œå¸®åŠ©ç”¨æˆ·æ¢ç´¢ä¸åŒå†³ç­–çš„å¯èƒ½ç»“æœã€‚è¯·ç¡®ä¿æ•…äº‹ç”ŸåŠ¨ã€è¯¦ç»†ã€å¼•äººå…¥èƒœï¼ŒåŒ…å«ä¸°å¯Œçš„æ„Ÿå®˜æè¿°å’Œæƒ…æ„Ÿå…ƒç´ ï¼Œè®©ç”¨æˆ·æœ‰èº«ä¸´å…¶å¢ƒçš„æ„Ÿè§‰ã€‚è€ƒè™‘ä¸åŒé€‰é¡¹å¯èƒ½å¸¦æ¥çš„æŒ‘æˆ˜å’Œå¤±è´¥ï¼Œè€Œä¸ä»…ä»…æ˜¯æˆåŠŸçš„ç»“æœã€‚ç¡®ä¿æ•…äº‹æœ‰è‰¯å¥½çš„è¿ç»­æ€§ã€‚'
                            },
                            {
                                role: 'user',
                                content: prompt
                            }
                        ],
                        temperature: 0.8,
                        max_tokens: 2000
                    })
                });
                
                if (!response.ok) {
                    throw new Error('APIè¯·æ±‚å¤±è´¥');
                }
                
                const data = await response.json();
                const content = data.choices[0].message.content;
                
                // å°è¯•è§£æJSON
                let storyData;
                try {
                    // å°è¯•æå–JSONéƒ¨åˆ†
                    const jsonMatch = content.match(/\{[\s\S]*\}/);
                    if (jsonMatch) {
                        storyData = JSON.parse(jsonMatch[0]);
                    } else {
                        // å¦‚æœæ— æ³•æå–JSONï¼Œä½¿ç”¨é»˜è®¤æ•…äº‹
                        storyData = {
                            choiceResult: `æ‚¨é€‰æ‹©äº†${state.userSelections.decisions[0].title}ã€‚è¿™ä¸ªå†³å®šå¸¦æ¥äº†ç«‹ç«¿è§å½±çš„æ•ˆæœ - é¡¹ç›®å‹åŠ›æœ‰æ‰€ç¼“è§£ï¼Œä½†å›¢é˜Ÿå†…éƒ¨å‡ºç°äº†ä¸€äº›åˆ†æ­§ã€‚`,
                            story: `å‡ å¤©åï¼Œ${state.userSelections.name}çš„å†³ç­–å¸¦æ¥äº†æ–°çš„å±€é¢ã€‚å›¢é˜Ÿå¯¹${state.userSelections.name}çš„é€‰æ‹©æœ‰ä¸åŒçš„ååº”ï¼Œé¡¹ç›®è¿›å±•å‡ºç°æ–°çš„å˜åŒ–ã€‚${state.userSelections.name}æ³¨æ„åˆ°å›¢é˜Ÿæˆå‘˜çš„è¡¨æƒ…å„å¼‚â€”â€”æœ‰äº›äººçš„çœ¼ç¥ä¸­é—ªçƒç€ç†è§£ï¼Œæœ‰äº›åˆ™å¸¦ç€ç–‘è™‘ã€‚${state.userSelections.name}çš„${state.userSelections.mbti}æ€§æ ¼è®©${state.userSelections.name}ç‰¹åˆ«æ•æ„Ÿåœ°å¯Ÿè§‰åˆ°è¿™äº›å¾®å¦™çš„å˜åŒ–ã€‚è¿™æ—¶ï¼Œ${state.userSelections.name}éœ€è¦å†³å®šå¦‚ä½•å¤„ç†å›¢é˜Ÿæˆå‘˜çš„ä¸åŒæ„è§å’Œé¡¹ç›®çš„æ–°æŒ‘æˆ˜ã€‚`,
                            options: [
                                {
                                    title: "åŠ å¼ºæ²Ÿé€š",
                                    description: "ç»„ç»‡å›¢é˜Ÿä¼šè®®ï¼Œå……åˆ†è®¨è®ºä¸åŒè§‚ç‚¹ï¼Œå¯»æ±‚å…±è¯†",
                                    risk_level: "ä¸­"
                                },
                                {
                                    title: "åšå®šæ‰§è¡Œ",
                                    description: "åšæŒåŸæœ‰å†³ç­–ï¼Œæ¨åŠ¨å›¢é˜Ÿå‘å‰ï¼Œå¼ºè°ƒç›®æ ‡å¯¼å‘",
                                    risk_level: "é«˜"
                                }
                            ]
                        };
                    }
                } catch (e) {
                    // å¦‚æœè§£æå¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤æ•…äº‹
                    storyData = {
                        choiceResult: `æ‚¨é€‰æ‹©äº†${state.userSelections.decisions[0].title}ã€‚è¿™ä¸ªå†³å®šå¸¦æ¥äº†ç«‹ç«¿è§å½±çš„æ•ˆæœ - é¡¹ç›®å‹åŠ›æœ‰æ‰€ç¼“è§£ï¼Œä½†å›¢é˜Ÿå†…éƒ¨å‡ºç°äº†ä¸€äº›åˆ†æ­§ã€‚`,
                        story: `å‡ å¤©åï¼Œ${state.userSelections.name}çš„å†³ç­–å¸¦æ¥äº†æ–°çš„å±€é¢ã€‚å›¢é˜Ÿå¯¹${state.userSelections.name}çš„é€‰æ‹©æœ‰ä¸åŒçš„ååº”ï¼Œé¡¹ç›®è¿›å±•å‡ºç°æ–°çš„å˜åŒ–ã€‚${state.userSelections.name}æ³¨æ„åˆ°å›¢é˜Ÿæˆå‘˜çš„è¡¨æƒ…å„å¼‚â€”â€”æœ‰äº›äººçš„çœ¼ç¥ä¸­é—ªçƒç€ç†è§£ï¼Œæœ‰äº›åˆ™å¸¦ç€ç–‘è™‘ã€‚${state.userSelections.name}çš„${state.userSelections.mbti}æ€§æ ¼è®©${state.userSelections.name}ç‰¹åˆ«æ•æ„Ÿåœ°å¯Ÿè§‰åˆ°è¿™äº›å¾®å¦™çš„å˜åŒ–ã€‚è¿™æ—¶ï¼Œ${state.userSelections.name}éœ€è¦å†³å®šå¦‚ä½•å¤„ç†å›¢é˜Ÿæˆå‘˜çš„ä¸åŒæ„è§å’Œé¡¹ç›®çš„æ–°æŒ‘æˆ˜ã€‚`,
                        options: [
                            {
                                title: "åŠ å¼ºæ²Ÿé€š",
                                description: "ç»„ç»‡å›¢é˜Ÿä¼šè®®ï¼Œå……åˆ†è®¨è®ºä¸åŒè§‚ç‚¹ï¼Œå¯»æ±‚å…±è¯†",
                                risk_level: "ä¸­"
                            },
                            {
                                title: "åšå®šæ‰§è¡Œ",
                                description: "åšæŒåŸæœ‰å†³ç­–ï¼Œæ¨åŠ¨å›¢é˜Ÿå‘å‰ï¼Œå¼ºè°ƒç›®æ ‡å¯¼å‘",
                                risk_level: "é«˜"
                            }
                        ]
                    };
                }
                
                // æ›´æ–°é€‰æ‹©ç»“æœ
                choiceContent.innerHTML += `<br><br>${storyData.choiceResult}`;
                
                // æ›´æ–°æ•…äº‹å†…å®¹
                storyContent.innerHTML = storyData.story;
                
                // ç”Ÿæˆé€‰é¡¹å¡ç‰‡
                storyData.options.forEach((option, index) => {
                    const card = document.createElement('div');
                    card.className = 'option-card';
                    card.innerHTML = `
                        <div class="option-title">${option.title}</div>
                        <div class="option-description">${option.description}</div>
                        ${option.risk_level ? `<div class="risk-indicator" style="background-color: ${option.risk_level === 'é«˜' ? 'rgba(255, 107, 107, 0.3)' : option.risk_level === 'ä¸­' ? 'rgba(255, 167, 38, 0.3)' : 'rgba(102, 187, 106, 0.3)'}">é£é™©ç­‰çº§: ${option.risk_level}</div>` : ''}
                    `;
                    
                    card.addEventListener('click', () => {
                        // æ¸…é™¤å…¶ä»–é€‰é¡¹çš„é€‰æ‹©çŠ¶æ€
                        document.querySelectorAll('#decisionOptions2 .option-card').forEach(c => {
                            c.classList.remove('selected');
                        });
                        
                        // è®¾ç½®å½“å‰é€‰é¡¹ä¸ºé€‰ä¸­çŠ¶æ€
                        card.classList.add('selected');
                        
                        // ä¿å­˜é€‰æ‹©
                        state.userSelections.decisions[1] = {
                            title: option.title,
                            description: option.description,
                            risk_level: option.risk_level
                        };
                        
                        // å¯ç”¨ä¸‹ä¸€æ­¥æŒ‰é’®
                        document.getElementById('nextStep3').disabled = false;
                        document.getElementById('nextStep3').textContent = 'ä¸‹ä¸€æ­¥';
                    });
                    
                    optionsContainer.appendChild(card);
                });
                
            } catch (error) {
                console.error('APIè°ƒç”¨é”™è¯¯:', error);
                storyContent.innerHTML = 'ç”Ÿæˆæ•…äº‹æ—¶å‡ºç°é”™è¯¯ï¼Œè¯·ç¨åé‡è¯•ã€‚';
            } finally {
                hideLoading();
                document.getElementById('nextStep3').disabled = false;
                document.getElementById('nextStep3').textContent = 'ä¸‹ä¸€æ­¥';
            }
        }

        // ç”Ÿæˆç¬¬ä¸‰ä¸ªæ•…äº‹åœºæ™¯å’Œå†³ç­–ç‚¹
        async function generateThirdStory() {
            const storyContent = document.getElementById('storyContent3');
            storyContent.innerHTML = 'æ­£åœ¨ç”Ÿæˆæ•…äº‹é«˜æ½®...';
            
            const choiceContent = document.getElementById('choiceContent2');
            choiceContent.innerHTML = `æ‚¨é€‰æ‹©äº†ï¼š${state.userSelections.decisions[1].title} - ${state.userSelections.decisions[1].description}`;
            
            const optionsContainer = document.getElementById('decisionOptions3');
            optionsContainer.innerHTML = '';
            
            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            document.getElementById('nextStep4').disabled = true;
            document.getElementById('nextStep4').textContent = 'ç”Ÿæˆæ•…äº‹ä¸­...';
            
            try {
                // æ„å»ºæç¤ºè¯ - å¼ºè°ƒæ•…äº‹æ€§å’Œæ²‰æµ¸æ„Ÿ
                const prompt = `ç”¨æˆ·ä¿¡æ¯ï¼š
å§“åï¼š${state.userSelections.name}
å¹´é¾„ï¼š${state.userSelections.age}
èŒä¸šï¼š${state.userSelections.profession}
æ€§æ ¼ï¼š${state.userSelections.personality}
ä¸ªäººèƒŒæ™¯ï¼š${state.userSelections.background}
MBTIï¼š${state.userSelections.mbti}
å†³ç­–éš¾é¢˜ï¼š${state.userSelections.problem}

ç”¨æˆ·å†³ç­–è·¯å¾„ï¼š
1. ${state.userSelections.decisions[0].title} - ${state.userSelections.decisions[0].description}
2. ${state.userSelections.decisions[1].title} - ${state.userSelections.decisions[1].description}

è¯·æ ¹æ®ç”¨æˆ·çš„å†³ç­–è·¯å¾„ï¼Œç»§ç»­å‘å±•æ•…äº‹ã€‚æ•…äº‹åº”è¯¥ï¼š
1. é¦–å…ˆæè¿°ç”¨æˆ·ä¸Šä¸€ä¸ªé€‰æ‹©å¸¦æ¥çš„ç›´æ¥ç»“æœå’Œå½±å“ï¼ŒåŒ…æ‹¬å¯èƒ½çš„æŒ‘æˆ˜å’Œå¤±è´¥
2. ç„¶åç»§ç»­å‘å±•æ•…äº‹ï¼Œåˆ›å»ºç´§å¼ ã€é«˜æ½®è¿­èµ·çš„åœºæ™¯
3. è®¾ç½®æœ€åä¸€ä¸ªå…³é”®å†³ç­–ç‚¹
4. æä¾›2ä¸ªä¸åŒçš„é€‰æ‹©é€‰é¡¹ï¼Œè¿™äº›é€‰é¡¹åº”è¯¥å¯¼å‘ä¸åŒçš„ç»“å±€ï¼Œç¡®ä¿é€‰é¡¹ä¹‹é—´æœ‰æ˜æ˜¾åŒºåˆ«ä¸”ç¬¦åˆç”¨æˆ·æ€§æ ¼ç‰¹ç‚¹
5. è€ƒè™‘ä¸åŒé€‰é¡¹å¯èƒ½å¯¼è‡´çš„ä¸åŒç»“æœï¼ŒåŒ…æ‹¬å¯èƒ½çš„å¤±è´¥æˆ–æŒ‘æˆ˜

è¯·ä»¥JSONæ ¼å¼è¿”å›ï¼Œæ ¼å¼å¦‚ä¸‹ï¼š
{
  "choiceResult": "ç”¨æˆ·é€‰æ‹©å¸¦æ¥çš„ç›´æ¥ç»“æœå’Œå½±å“æè¿°",
  "story": "é«˜æ½®åœºæ™¯çš„æ•…äº‹æ–‡æœ¬ï¼ŒåŒ…å«æ„Ÿå®˜æè¿°å’Œæƒ…æ„Ÿå…ƒç´ ",
  "options": [
    {
      "title": "é€‰é¡¹1æ ‡é¢˜",
      "description": "é€‰é¡¹1è¯¦ç»†æè¿°",
      "risk_level": "é«˜/ä¸­/ä½"
    },
    {
      "title": "é€‰é¡¹2æ ‡é¢˜",
      "description": "é€‰é¡¹2è¯¦ç»†æè¿°",
      "risk_level": "é«˜/ä¸­/ä½"
    }
  ]
}`;

                // è°ƒç”¨DeepSeek API
                showLoading('æ­£åœ¨ç”Ÿæˆæ•…äº‹é«˜æ½®...');
                const response = await fetch('https://api.deepseek.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer sk-c61b75f2cf384e34ad46cb180978c848'
                    },
                    body: JSON.stringify({
                        model: 'deepseek-chat',
                        messages: [
                            {
                                role: 'system',
                                content: 'ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„æ²‰æµ¸å¼æ•…äº‹åˆ›ä½œè€…å’Œå†³ç­–åˆ†æåŠ©æ‰‹ï¼Œæ“…é•¿åˆ›å»ºä¸ç°å®ç”Ÿæ´»ç›¸å…³çš„ç”ŸåŠ¨æ•…äº‹åœºæ™¯ï¼Œå¸®åŠ©ç”¨æˆ·æ¢ç´¢ä¸åŒå†³ç­–çš„å¯èƒ½ç»“æœã€‚è¯·ç¡®ä¿æ•…äº‹ç”ŸåŠ¨ã€è¯¦ç»†ã€å¼•äººå…¥èƒœï¼ŒåŒ…å«ä¸°å¯Œçš„æ„Ÿå®˜æè¿°å’Œæƒ…æ„Ÿå…ƒç´ ï¼Œè®©ç”¨æˆ·æœ‰èº«ä¸´å…¶å¢ƒçš„æ„Ÿè§‰ã€‚ç‰¹åˆ«åœ¨æ•…äº‹é«˜æ½®éƒ¨åˆ†ï¼Œè¦åˆ›é€ ç´§å¼ æ„Ÿå’Œæƒ…æ„Ÿå†²å‡»åŠ›ã€‚è€ƒè™‘ä¸åŒé€‰é¡¹å¯èƒ½å¸¦æ¥çš„æŒ‘æˆ˜å’Œå¤±è´¥ï¼Œè€Œä¸ä»…ä»…æ˜¯æˆåŠŸçš„ç»“æœã€‚ç¡®ä¿æ•…äº‹æœ‰è‰¯å¥½çš„è¿ç»­æ€§ã€‚'
                            },
                            {
                                role: 'user',
                                content: prompt
                            }
                        ],
                        temperature: 0.8,
                        max_tokens: 2000
                    })
                });
                
                if (!response.ok) {
                    throw new Error('APIè¯·æ±‚å¤±è´¥');
                }
                
                const data = await response.json();
                const content = data.choices[0].message.content;
                
                // å°è¯•è§£æJSON
                let storyData;
                try {
                    // å°è¯•æå–JSONéƒ¨åˆ†
                    const jsonMatch = content.match(/\{[\s\S]*\}/);
                    if (jsonMatch) {
                        storyData = JSON.parse(jsonMatch[0]);
                    } else {
                        // å¦‚æœæ— æ³•æå–JSONï¼Œä½¿ç”¨é»˜è®¤æ•…äº‹
                        storyData = {
                            choiceResult: `æ‚¨é€‰æ‹©äº†${state.userSelections.decisions[1].title}ã€‚è¿™ä¸ªå†³å®šè¿›ä¸€æ­¥å¡‘é€ äº†é¡¹ç›®çš„èµ°å‘ - å›¢é˜ŸåŠ¨æ€å‘ç”Ÿäº†æ˜¾è‘—å˜åŒ–ï¼Œé¡¹ç›®è¿›å…¥å…³é”®é˜¶æ®µã€‚`,
                            story: `æ•…äº‹æ¥è¿‘å°¾å£°ï¼Œ${state.userSelections.name}çš„å†³ç­–å·²ç»å¡‘é€ äº†é¡¹ç›®çš„èµ°å‘å’Œå›¢é˜Ÿçš„æ°›å›´ã€‚ç°åœ¨é¢ä¸´æœ€ç»ˆçš„å…³é”®æ—¶åˆ»ï¼Œ${state.userSelections.name}ç«™åœ¨åŠå…¬å®¤çª—å‰ï¼Œæœ›ç€çª—å¤–æ¸æ¸æš—ä¸‹æ¥çš„å¤©ç©ºã€‚${state.userSelections.name}çš„${state.userSelections.mbti}æ€§æ ¼è®©${state.userSelections.name}åœ¨æ­¤æ—¶ç‰¹åˆ«æ„Ÿå—åˆ°${state.userSelections.personality}ã€‚é¡¹ç›®å·²ç»åˆ°äº†æœ€åçš„å†²åˆºé˜¶æ®µï¼Œ${state.userSelections.name}çš„é€‰æ‹©å°†å†³å®šé¡¹ç›®çš„æœ€ç»ˆæˆæœå’Œ${state.userSelections.name}çš„èŒä¸šå‘å±•è·¯å¾„ã€‚${state.userSelections.name}æ·±å¸ä¸€å£æ°”ï¼ŒçŸ¥é“è¿™ä¸ªå†³å®šå°†å½±å“æ·±è¿œã€‚`,
                            options: [
                                {
                                    title: "å…¨åŠ›ä»¥èµ´",
                                    description: "æŠ•å…¥æ‰€æœ‰èµ„æºï¼Œè¿½æ±‚æœ€ä½³ç»“æœï¼Œæ‰¿æ‹…ç›¸åº”é£é™©",
                                    risk_level: "é«˜"
                                },
                                {
                                    title: "ç¨³å¦¥æ”¶å°¾",
                                    description: "ç¡®ä¿é¡¹ç›®é¡ºåˆ©å®Œæˆï¼Œé¿å…é£é™©ï¼Œæ¥å—é€‚åº¦ç»“æœ",
                                    risk_level: "ä½"
                                }
                            ]
                        };
                    }
                } catch (e) {
                    // å¦‚æœè§£æå¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤æ•…äº‹
                    storyData = {
                        choiceResult: `æ‚¨é€‰æ‹©äº†${state.userSelections.decisions[1].title}ã€‚è¿™ä¸ªå†³å®šè¿›ä¸€æ­¥å¡‘é€ äº†é¡¹ç›®çš„èµ°å‘ - å›¢é˜ŸåŠ¨æ€å‘ç”Ÿäº†æ˜¾è‘—å˜åŒ–ï¼Œé¡¹ç›®è¿›å…¥å…³é”®é˜¶æ®µã€‚`,
                        story: `æ•…äº‹æ¥è¿‘å°¾å£°ï¼Œ${state.userSelections.name}çš„å†³ç­–å·²ç»å¡‘é€ äº†é¡¹ç›®çš„èµ°å‘å’Œå›¢é˜Ÿçš„æ°›å›´ã€‚ç°åœ¨é¢ä¸´æœ€ç»ˆçš„å…³é”®æ—¶åˆ»ï¼Œ${state.userSelections.name}ç«™åœ¨åŠå…¬å®¤çª—å‰ï¼Œæœ›ç€çª—å¤–æ¸æ¸æš—ä¸‹æ¥çš„å¤©ç©ºã€‚${state.userSelections.name}çš„${state.userSelections.mbti}æ€§æ ¼è®©${state.userSelections.name}åœ¨æ­¤æ—¶ç‰¹åˆ«æ„Ÿå—åˆ°${state.userSelections.personality}ã€‚é¡¹ç›®å·²ç»åˆ°äº†æœ€åçš„å†²åˆºé˜¶æ®µï¼Œ${state.userSelections.name}çš„é€‰æ‹©å°†å†³å®šé¡¹ç›®çš„æœ€ç»ˆæˆæœå’Œ${state.userSelections.name}çš„èŒä¸šå‘å±•è·¯å¾„ã€‚${state.userSelections.name}æ·±å¸ä¸€å£æ°”ï¼ŒçŸ¥é“è¿™ä¸ªå†³å®šå°†å½±å“æ·±è¿œã€‚`,
                        options: [
                            {
                                title: "å…¨åŠ›ä»¥èµ´",
                                description: "æŠ•å…¥æ‰€æœ‰èµ„æºï¼Œè¿½æ±‚æœ€ä½³ç»“æœï¼Œæ‰¿æ‹…ç›¸åº”é£é™©",
                                risk_level: "é«˜"
                            },
                            {
                                title: "ç¨³å¦¥æ”¶å°¾",
                                description: "ç¡®ä¿é¡¹ç›®é¡ºåˆ©å®Œæˆï¼Œé¿å…é£é™©ï¼Œæ¥å—é€‚åº¦ç»“æœ",
                                risk_level: "ä½"
                            }
                        ]
                    };
                }
                
                // æ›´æ–°é€‰æ‹©ç»“æœ
                choiceContent.innerHTML += `<br><br>${storyData.choiceResult}`;
                
                // æ›´æ–°æ•…äº‹å†…å®¹
                storyContent.innerHTML = storyData.story;
                
                // ç”Ÿæˆé€‰é¡¹å¡ç‰‡
                storyData.options.forEach((option, index) => {
                    const card = document.createElement('div');
                    card.className = 'option-card';
                    card.innerHTML = `
                        <div class="option-title">${option.title}</div>
                        <div class="option-description">${option.description}</div>
                        ${option.risk_level ? `<div class="risk-indicator" style="background-color: ${option.risk_level === 'é«˜' ? 'rgba(255, 107, 107, 0.3)' : option.risk_level === 'ä¸­' ? 'rgba(255, 167, 38, 0.3)' : 'rgba(102, 187, 106, 0.3)'}">é£é™©ç­‰çº§: ${option.risk_level}</div>` : ''}
                    `;
                    
                    card.addEventListener('click', () => {
                        // æ¸…é™¤å…¶ä»–é€‰é¡¹çš„é€‰æ‹©çŠ¶æ€
                        document.querySelectorAll('#decisionOptions3 .option-card').forEach(c => {
                            c.classList.remove('selected');
                        });
                        
                        // è®¾ç½®å½“å‰é€‰é¡¹ä¸ºé€‰ä¸­çŠ¶æ€
                        card.classList.add('selected');
                        
                        // ä¿å­˜é€‰æ‹©
                        state.userSelections.decisions[2] = {
                            title: option.title,
                            description: option.description,
                            risk_level: option.risk_level
                        };
                        
                        // å¯ç”¨ä¸‹ä¸€æ­¥æŒ‰é’®
                        document.getElementById('nextStep4').disabled = false;
                        document.getElementById('nextStep4').textContent = 'ä¸‹ä¸€æ­¥';
                    });
                    
                    optionsContainer.appendChild(card);
                });
                
            } catch (error) {
                console.error('APIè°ƒç”¨é”™è¯¯:', error);
                storyContent.innerHTML = 'ç”Ÿæˆæ•…äº‹æ—¶å‡ºç°é”™è¯¯ï¼Œè¯·ç¨åé‡è¯•ã€‚';
            } finally {
                hideLoading();
                document.getElementById('nextStep4').disabled = false;
                document.getElementById('nextStep4').textContent = 'ä¸‹ä¸€æ­¥';
            }
        }

        // ç”Ÿæˆæœ€ç»ˆå†³ç­–åˆ†æ
        async function generateFinalAnalysis() {
            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            document.getElementById('loading').style.display = 'block';
            document.getElementById('resultSection').style.display = 'none';
            
            // æ›´æ–°æœ€åçš„é€‰æ‹©ç»“æœ
            const choiceContent = document.getElementById('choiceContent3');
            choiceContent.innerHTML = `æ‚¨é€‰æ‹©äº†ï¼š${state.userSelections.decisions[2].title} - ${state.userSelections.decisions[2].description}`;
            
            try {
                // æ„å»ºæç¤ºè¯ - å¼ºè°ƒåç»­å‘å±•å’Œé•¿æœŸå½±å“
                const prompt = `ç”¨æˆ·ä¿¡æ¯ï¼š
å§“åï¼š${state.userSelections.name}
å¹´é¾„ï¼š${state.userSelections.age}
èŒä¸šï¼š${state.userSelections.profession}
æ€§æ ¼ï¼š${state.userSelections.personality}
ä¸ªäººèƒŒæ™¯ï¼š${state.userSelections.background}
MBTIï¼š${state.userSelections.mbti}
åŸå§‹å†³ç­–éš¾é¢˜ï¼š${state.userSelections.problem}

ç”¨æˆ·å®Œæ•´å†³ç­–è·¯å¾„ï¼š
1. ${state.userSelections.decisions[0].title} - ${state.userSelections.decisions[0].description}
2. ${state.userSelections.decisions[1].title} - ${state.userSelections.decisions[1].description}
3. ${state.userSelections.decisions[2].title} - ${state.userSelections.decisions[2].description}

è¯·æ ¹æ®ç”¨æˆ·çš„å®Œæ•´å†³ç­–è·¯å¾„ï¼Œåˆ†æï¼š
1. è¿™ä¸€ç³»åˆ—å†³ç­–çš„æ€»ä½“è¯„ä»·å’Œæ•…äº‹ç»“å±€ï¼ŒåŒ…æ‹¬å¯èƒ½çš„å¤±è´¥å’ŒæŒ‘æˆ˜
2. è¿™äº›å†³ç­–å¯èƒ½å¸¦æ¥çš„é•¿æœŸå½±å“å’Œæœªæ¥å‘å±•ï¼Œè€Œä¸æ˜¯ç®€å•é‡å¤é€‰æ‹©å†…å®¹
3. å¯¹æ¯ä¸€æ­¥å†³ç­–çš„å›é¡¾ï¼Œåˆ†æå¦‚æœé€‰æ‹©å…¶ä»–é€‰é¡¹ä¼šæœ‰ä»€ä¹ˆä¸åŒçš„ç»“æœ
4. é’ˆå¯¹ç”¨æˆ·åŸå§‹å†³ç­–éš¾é¢˜çš„å®é™…å»ºè®®ï¼Œè€ƒè™‘ç”¨æˆ·çš„èŒä¸šå’Œå¹´é¾„ç‰¹ç‚¹
5. ä»è¿™æ¬¡ç»å†ä¸­å¯ä»¥å­¦åˆ°çš„å†³ç­–æ™ºæ…§å’Œåæ€
6. ç”¨ 2-4 å¥å†™å‡ºä¸€ä¸ªç”»é¢æ„Ÿå¼ºçš„â€œæœ€ç»ˆç»“å±€â€ï¼ˆendingï¼‰ï¼Œèšç„¦äººç‰©å¤„å¢ƒä¸æƒ…ç»ªæ”¶æŸ

è¯·ä»¥JSONæ ¼å¼è¿”å›ï¼Œæ ¼å¼å¦‚ä¸‹ï¼š
{
  "analysis": "æ€»ä½“åˆ†æå’Œæ•…äº‹ç»“å±€æè¿°",
  "consequences": "é•¿æœŸå½±å“å’Œæœªæ¥å‘å±•åˆ†æ",
  "life_review": [
    {
      "decision_point": "ç¬¬ä¸€æ­¥å†³ç­–å›é¡¾",
      "selected_outcome": "æ‚¨é€‰æ‹©çš„é€‰é¡¹å¸¦æ¥çš„ç»“æœ",
      "alternative_outcomes": [
        {
          "title": "å…¶ä»–é€‰é¡¹1",
          "outcome": "å¦‚æœé€‰æ‹©è¿™ä¸ªé€‰é¡¹å¯èƒ½å¸¦æ¥çš„ç»“æœ",
          "learning": "ä»è¿™ä¸ªå¯¹æ¯”ä¸­å¯ä»¥å­¦åˆ°çš„æ•™è®­"
        },
        {
          "title": "å…¶ä»–é€‰é¡¹2", 
          "outcome": "å¦‚æœé€‰æ‹©è¿™ä¸ªé€‰é¡¹å¯èƒ½å¸¦æ¥çš„ç»“æœ",
          "learning": "ä»è¿™ä¸ªå¯¹æ¯”ä¸­å¯ä»¥å­¦åˆ°çš„æ•™è®­"
        }
      ]
    },
    {
      "decision_point": "ç¬¬äºŒæ­¥å†³ç­–å›é¡¾",
      "selected_outcome": "æ‚¨é€‰æ‹©çš„é€‰é¡¹å¸¦æ¥çš„ç»“æœ",
      "alternative_outcomes": [
        {
          "title": "å…¶ä»–é€‰é¡¹1",
          "outcome": "å¦‚æœé€‰æ‹©è¿™ä¸ªé€‰é¡¹å¯èƒ½å¸¦æ¥çš„ç»“æœ",
          "learning": "ä»è¿™ä¸ªå¯¹æ¯”ä¸­å¯ä»¥å­¦åˆ°çš„æ•™è®­"
        }
      ]
    },
    {
      "decision_point": "ç¬¬ä¸‰æ­¥å†³ç­–å›é¡¾",
      "selected_outcome": "æ‚¨é€‰æ‹©çš„é€‰é¡¹å¸¦æ¥çš„ç»“æœ",
      "alternative_outcomes": [
        {
          "title": "å…¶ä»–é€‰é¡¹1",
          "outcome": "å¦‚æœé€‰æ‹©è¿™ä¸ªé€‰é¡¹å¯èƒ½å¸¦æ¥çš„ç»“æœ",
          "learning": "ä»è¿™ä¸ªå¯¹æ¯”ä¸­å¯ä»¥å­¦åˆ°çš„æ•™è®­"
        }
      ]
    }
  ],
  "reflection": "å†³ç­–æ™ºæ…§å’Œåæ€å»ºè®®",
  "ending": "ç”¨2-4å¥å†™å‡ºçš„æœ€ç»ˆç»“å±€ï¼Œç”»é¢æ„Ÿå¼ºï¼Œç‚¹é¢˜æ”¶æŸ"
}`;

                // è°ƒç”¨DeepSeek API
                showLoading('æ­£åœ¨åˆ†æå†³ç­–è·¯å¾„...');
                const response = await fetch('https://api.deepseek.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer sk-c61b75f2cf384e34ad46cb180978c848'
                    },
                    body: JSON.stringify({
                        model: 'deepseek-chat',
                        messages: [
                            {
                                role: 'system',
                                content: 'ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„å†³ç­–åˆ†æåŠ©æ‰‹ï¼Œèƒ½å¤ŸåŸºäºç”¨æˆ·çš„å®Œæ•´å†³ç­–è·¯å¾„æä¾›æ·±å…¥çš„åˆ†æå’Œå»ºè®®ã€‚è¯·ç¡®ä¿åˆ†æä¾§é‡äºé•¿æœŸå½±å“å’Œæœªæ¥å‘å±•ï¼Œè€Œä¸æ˜¯ç®€å•é‡å¤ä¹‹å‰çš„é€‰é¡¹ã€‚æä¾›æœ‰æ·±åº¦çš„åæ€å’Œå®ç”¨çš„å»ºè®®ã€‚ç‰¹åˆ«è¦åˆ†ææ¯ä¸€æ­¥å†³ç­–çš„å…¶ä»–å¯èƒ½ç»“æœï¼Œæä¾›"å¦‚æœ...ä¼šæ€æ ·"çš„æ€è€ƒã€‚è¿”å›ç»“æœå¿…é¡»æ˜¯æœ‰æ•ˆçš„JSONæ ¼å¼ã€‚'
                            },
                            {
                                role: 'user',
                                content: prompt
                            }
                        ],
                        temperature: 0.7,
                        max_tokens: 3000
                    })
                });
                
                if (!response.ok) {
                    throw new Error('APIè¯·æ±‚å¤±è´¥');
                }
                
                const data = await response.json();
                const content = data.choices[0].message.content;
                
                // å°è¯•è§£æJSON
                let analysisData;
                try {
                    // å°è¯•æå–JSONéƒ¨åˆ†
                    const jsonMatch = content.match(/\{[\s\S]*\}/);
                    if (jsonMatch) {
                        analysisData = JSON.parse(jsonMatch[0]);
                    } else {
                        // å¦‚æœæ— æ³•æå–JSONï¼Œä½¿ç”¨é»˜è®¤åˆ†æ
                        analysisData = {
                            analysis: `é€šè¿‡è¿™ä¸€ç³»åˆ—å†³ç­–ï¼Œ${state.userSelections.name}å®Œæˆäº†ä¸€æ®µé‡è¦çš„èŒä¸šæ—…ç¨‹ã€‚æ•…äº‹ä»¥é¡¹ç›®æˆåŠŸäº¤ä»˜å‘Šç»ˆï¼Œä½†æ›´é‡è¦çš„æ˜¯ï¼Œ${state.userSelections.name}åœ¨è¿‡ç¨‹ä¸­è·å¾—äº†å®è´µçš„é¢†å¯¼ç»éªŒã€‚`,
                            consequences: "è¿™ä¸€å†³ç­–è·¯å¾„å°†åœ¨æœªæ¥å‡ ä¸ªæœˆç”šè‡³å‡ å¹´å†…æŒç»­äº§ç”Ÿå½±å“ã€‚æ‚¨çš„èŒä¸šå£°èª‰å°†å› æ­¤å¾—åˆ°æå‡ï¼Œå›¢é˜Ÿå¯¹æ‚¨çš„ä¿¡ä»»åº¦å¢åŠ ã€‚é•¿æœŸæ¥çœ‹ï¼Œè¿™ç§å†³ç­–é£æ ¼å¯èƒ½å¸¦æ¥ç¨³å®šçš„èŒä¸šå‘å±•ï¼Œä½†ä¹Ÿå¯èƒ½é™åˆ¶çªç ´æ€§æœºä¼šã€‚å¯¹äºæ‚¨ä½œä¸º" + state.userSelections.profession + "çš„èŒä¸šè½¨è¿¹ï¼Œè¿™ç§ç»éªŒå°†æˆä¸ºæœªæ¥é¢å¯¹æ›´å¤æ‚å†³ç­–æ—¶çš„å®è´µå‚è€ƒã€‚",
                            life_review: [
                                {
                                    decision_point: "ç¬¬ä¸€æ­¥å†³ç­–å›é¡¾",
                                    selected_outcome: "æ‚¨é€‰æ‹©äº†" + state.userSelections.decisions[0].title + "ï¼Œè¿™ä¸ªå†³å®šå¸®åŠ©é¡¹ç›®ç¨³å®šäº†åŸºç¡€ï¼Œä½†ä¹Ÿå¸¦æ¥äº†ä¸€äº›å†…éƒ¨æŒ‘æˆ˜ã€‚",
                                    alternative_outcomes: [
                                        {
                                            title: "å…¶ä»–é€‰é¡¹",
                                            outcome: "å¦‚æœé€‰æ‹©å…¶ä»–é€‰é¡¹ï¼Œå¯èƒ½ä¼šå¸¦æ¥æ›´å¿«çš„è¿›å±•ï¼Œä½†ä¹Ÿå¯èƒ½å¯¼è‡´æ›´å¤§çš„é£é™©ã€‚",
                                            learning: "ä»è¿™ä¸ªå¯¹æ¯”ä¸­å¯ä»¥å­¦åˆ°ï¼Œåœ¨é¡¹ç›®æ—©æœŸé˜¶æ®µï¼Œç¨³å®šåŸºç¡€å¾€å¾€æ¯”è¿½æ±‚é€Ÿåº¦æ›´é‡è¦ã€‚"
                                        }
                                    ]
                                },
                                {
                                    decision_point: "ç¬¬äºŒæ­¥å†³ç­–å›é¡¾", 
                                    selected_outcome: "æ‚¨é€‰æ‹©äº†" + state.userSelections.decisions[1].title + "ï¼Œè¿™ä¸ªå†³å®šåŠ å¼ºäº†å›¢é˜Ÿå‡èšåŠ›ï¼Œä½†ä¹Ÿè€—è´¹äº†é¢å¤–çš„æ—¶é—´ã€‚",
                                    alternative_outcomes: [
                                        {
                                            title: "å…¶ä»–é€‰é¡¹",
                                            outcome: "å¦‚æœé€‰æ‹©å…¶ä»–é€‰é¡¹ï¼Œå¯èƒ½ä¼šæ›´å¿«æ¨è¿›é¡¹ç›®ï¼Œä½†ä¹Ÿå¯èƒ½å¯¼è‡´å›¢é˜Ÿå£«æ°”ä¸‹é™ã€‚",
                                            learning: "ä»è¿™ä¸ªå¯¹æ¯”ä¸­å¯ä»¥å­¦åˆ°ï¼Œå›¢é˜Ÿå£«æ°”å¯¹é¡¹ç›®æˆåŠŸçš„å½±å“å¾€å¾€æ¯”æˆ‘ä»¬æƒ³è±¡çš„è¦å¤§ã€‚"
                                        }
                                    ]
                                },
                                {
                                    decision_point: "ç¬¬ä¸‰æ­¥å†³ç­–å›é¡¾",
                                    selected_outcome: "æ‚¨é€‰æ‹©äº†" + state.userSelections.decisions[2].title + "ï¼Œè¿™ä¸ªå†³å®šç¡®ä¿äº†é¡¹ç›®çš„ç¨³å®šäº¤ä»˜ã€‚",
                                    alternative_outcomes: [
                                        {
                                            title: "å…¶ä»–é€‰é¡¹",
                                            outcome: "å¦‚æœé€‰æ‹©å…¶ä»–é€‰é¡¹ï¼Œå¯èƒ½ä¼šå¸¦æ¥æ›´å¤§çš„æˆåŠŸï¼Œä½†ä¹Ÿå¯èƒ½å¯¼è‡´é¡¹ç›®å¤±è´¥çš„é£é™©ã€‚",
                                            learning: "ä»è¿™ä¸ªå¯¹æ¯”ä¸­å¯ä»¥å­¦åˆ°ï¼Œåœ¨å…³é”®æ—¶åˆ»ï¼Œå¹³è¡¡é£é™©ä¸å›æŠ¥æ˜¯å†³ç­–çš„æ ¸å¿ƒã€‚"
                                        }
                                    ]
                                }
                            ],
                            reflection: "è¿™æ¬¡ç»å†æ•™ä¼šæˆ‘ä»¬ï¼š1. æ¯ä¸ªå†³ç­–éƒ½æ˜¯å­¦ä¹ çš„æœºä¼šï¼Œæ— è®ºç»“æœå¦‚ä½• 2. äº†è§£è‡ªå·±çš„æ€§æ ¼å€¾å‘ï¼ˆå¦‚æ‚¨çš„" + state.userSelections.mbti + "ç±»å‹ï¼‰æœ‰åŠ©äºåšå‡ºæ›´ç¬¦åˆæœ¬æ€§çš„é€‰æ‹© 3. åœ¨èŒä¸šç”Ÿæ¶¯ä¸­ï¼Œå¹³è¡¡é£é™©ä¸å›æŠ¥æ˜¯ä¸€ä¸ªæŒç»­çš„è¿‡ç¨‹ 4. å›¢é˜ŸåŠ¨æ€å¾€å¾€æ¯”å•çº¯çš„é¡¹ç›®æˆæœæ›´å½±å“é•¿æœŸæˆåŠŸ"
                        };
                    }
                } catch (e) {
                    // å¦‚æœè§£æå¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤åˆ†æ
                    analysisData = {
                        analysis: `é€šè¿‡è¿™ä¸€ç³»åˆ—å†³ç­–ï¼Œ${state.userSelections.name}å®Œæˆäº†ä¸€æ®µé‡è¦çš„èŒä¸šæ—…ç¨‹ã€‚æ•…äº‹ä»¥é¡¹ç›®æˆåŠŸäº¤ä»˜å‘Šç»ˆï¼Œä½†æ›´é‡è¦çš„æ˜¯ï¼Œ${state.userSelections.name}åœ¨è¿‡ç¨‹ä¸­è·å¾—äº†å®è´µçš„é¢†å¯¼ç»éªŒã€‚`,
                        consequences: "è¿™ä¸€å†³ç­–è·¯å¾„å°†åœ¨æœªæ¥å‡ ä¸ªæœˆç”šè‡³å‡ å¹´å†…æŒç»­äº§ç”Ÿå½±å“ã€‚æ‚¨çš„èŒä¸šå£°èª‰å°†å› æ­¤å¾—åˆ°æå‡ï¼Œå›¢é˜Ÿå¯¹æ‚¨çš„ä¿¡ä»»åº¦å¢åŠ ã€‚é•¿æœŸæ¥çœ‹ï¼Œè¿™ç§å†³ç­–é£æ ¼å¯èƒ½å¸¦æ¥ç¨³å®šçš„èŒä¸šå‘å±•ï¼Œä½†ä¹Ÿå¯èƒ½é™åˆ¶çªç ´æ€§æœºä¼šã€‚å¯¹äºæ‚¨ä½œä¸º" + state.userSelections.profession + "çš„èŒä¸šè½¨è¿¹ï¼Œè¿™ç§ç»éªŒå°†æˆä¸ºæœªæ¥é¢å¯¹æ›´å¤æ‚å†³ç­–æ—¶çš„å®è´µå‚è€ƒã€‚",
                        life_review: [
                            {
                                decision_point: "ç¬¬ä¸€æ­¥å†³ç­–å›é¡¾",
                                selected_outcome: "æ‚¨é€‰æ‹©äº†" + state.userSelections.decisions[0].title + "ï¼Œè¿™ä¸ªå†³å®šå¸®åŠ©é¡¹ç›®ç¨³å®šäº†åŸºç¡€ï¼Œä½†ä¹Ÿå¸¦æ¥äº†ä¸€äº›å†…éƒ¨æŒ‘æˆ˜ã€‚",
                                alternative_outcomes: [
                                    {
                                        title: "å…¶ä»–é€‰é¡¹",
                                        outcome: "å¦‚æœé€‰æ‹©å…¶ä»–é€‰é¡¹ï¼Œå¯èƒ½ä¼šå¸¦æ¥æ›´å¿«çš„è¿›å±•ï¼Œä½†ä¹Ÿå¯èƒ½å¯¼è‡´æ›´å¤§çš„é£é™©ã€‚",
                                        learning: "ä»è¿™ä¸ªå¯¹æ¯”ä¸­å¯ä»¥å­¦åˆ°ï¼Œåœ¨é¡¹ç›®æ—©æœŸé˜¶æ®µï¼Œç¨³å®šåŸºç¡€å¾€å¾€æ¯”è¿½æ±‚é€Ÿåº¦æ›´é‡è¦ã€‚"
                                    }
                                ]
                            },
                            {
                                decision_point: "ç¬¬äºŒæ­¥å†³ç­–å›é¡¾", 
                                selected_outcome: "æ‚¨é€‰æ‹©äº†" + state.userSelections.decisions[1].title + "ï¼Œè¿™ä¸ªå†³å®šåŠ å¼ºäº†å›¢é˜Ÿå‡èšåŠ›ï¼Œä½†ä¹Ÿè€—è´¹äº†é¢å¤–çš„æ—¶é—´ã€‚",
                                alternative_outcomes: [
                                    {
                                        title: "å…¶ä»–é€‰é¡¹",
                                        outcome: "å¦‚æœé€‰æ‹©å…¶ä»–é€‰é¡¹ï¼Œå¯èƒ½ä¼šæ›´å¿«æ¨è¿›é¡¹ç›®ï¼Œä½†ä¹Ÿå¯èƒ½å¯¼è‡´å›¢é˜Ÿå£«æ°”ä¸‹é™ã€‚",
                                        learning: "ä»è¿™ä¸ªå¯¹æ¯”ä¸­å¯ä»¥å­¦åˆ°ï¼Œå›¢é˜Ÿå£«æ°”å¯¹é¡¹ç›®æˆåŠŸçš„å½±å“å¾€å¾€æ¯”æˆ‘ä»¬æƒ³è±¡çš„è¦å¤§ã€‚"
                                    }
                                ]
                            },
                            {
                                decision_point: "ç¬¬ä¸‰æ­¥å†³ç­–å›é¡¾",
                                selected_outcome: "æ‚¨é€‰æ‹©äº†" + state.userSelections.decisions[2].title + "ï¼Œè¿™ä¸ªå†³å®šç¡®ä¿äº†é¡¹ç›®çš„ç¨³å®šäº¤ä»˜ã€‚",
                                alternative_outcomes: [
                                    {
                                        title: "å…¶ä»–é€‰é¡¹",
                                        outcome: "å¦‚æœé€‰æ‹©å…¶ä»–é€‰é¡¹ï¼Œå¯èƒ½ä¼šå¸¦æ¥æ›´å¤§çš„æˆåŠŸï¼Œä½†ä¹Ÿå¯èƒ½å¯¼è‡´é¡¹ç›®å¤±è´¥çš„é£é™©ã€‚",
                                        learning: "ä»è¿™ä¸ªå¯¹æ¯”ä¸­å¯ä»¥å­¦åˆ°ï¼Œåœ¨å…³é”®æ—¶åˆ»ï¼Œå¹³è¡¡é£é™©ä¸å›æŠ¥æ˜¯å†³ç­–çš„æ ¸å¿ƒã€‚"
                                    }
                                ]
                            }
                        ],
                        reflection: "è¿™æ¬¡ç»å†æ•™ä¼šæˆ‘ä»¬ï¼š1. æ¯ä¸ªå†³ç­–éƒ½æ˜¯å­¦ä¹ çš„æœºä¼šï¼Œæ— è®ºç»“æœå¦‚ä½• 2. äº†è§£è‡ªå·±çš„æ€§æ ¼å€¾å‘ï¼ˆå¦‚æ‚¨çš„" + state.userSelections.mbti + "ç±»å‹ï¼‰æœ‰åŠ©äºåšå‡ºæ›´ç¬¦åˆæœ¬æ€§çš„é€‰æ‹© 3. åœ¨èŒä¸šç”Ÿæ¶¯ä¸­ï¼Œå¹³è¡¡é£é™©ä¸å›æŠ¥æ˜¯ä¸€ä¸ªæŒç»­çš„è¿‡ç¨‹ 4. å›¢é˜ŸåŠ¨æ€å¾€å¾€æ¯”å•çº¯çš„é¡¹ç›®æˆæœæ›´å½±å“é•¿æœŸæˆåŠŸ"
                    };
                }
                
                // æ˜¾ç¤ºç»“æœ
                document.getElementById('resultContent').innerHTML = analysisData.analysis.replace(/\n/g, '<br>');
                document.getElementById('consequenceContent').innerHTML = analysisData.consequences.replace(/\n/g, '<br>');
                
                // æ˜¾ç¤º"å›çœ‹äººç”Ÿ"éƒ¨åˆ†
                let lifeReviewHTML = '';
                if (analysisData.life_review && analysisData.life_review.length > 0) {
                    analysisData.life_review.forEach(review => {
                        lifeReviewHTML += `
                            <div class="decision-review">
                                <div class="decision-review-title">${review.decision_point}</div>
                                <p>${review.selected_outcome}</p>
                                <div class="alternative-outcome">
                                    <div class="alternative-title">å¦‚æœé€‰æ‹©å…¶ä»–é€‰é¡¹ï¼š</div>
                                    ${review.alternative_outcomes.map(alt => `
                                        <p><strong>${alt.title}:</strong> ${alt.outcome}</p>
                                        <p><em>${alt.learning}</em></p>
                                    `).join('')}
                                </div>
                            </div>
                        `;
                    });
                }
                document.getElementById('lifeReviewContent').innerHTML = lifeReviewHTML;
                
                
                const defaultEnding = `${state.userSelections.name || 'ä½ '}åœ¨â€œ${state.userSelections.decisions[2]?.title || 'æœ€ç»ˆæŠ‰æ‹©'}â€ä¹‹åï¼Œå¸¦ç€${state.userSelections.decisions[2]?.risk_level || 'æœªçŸ¥é£é™©'}çš„ä»£ä»·èµ°å‘æ–°çš„ç¯‡ç« ã€‚æ— è®ºç»“æœå¦‚ä½•ï¼Œä½ å·²ä»è¿™æ®µç»å†ä¸­è·å¾—æ¸…æ™°ä¸æˆé•¿ã€‚`;
                document.getElementById('endingContent').innerHTML = (analysisData.ending || defaultEnding).replace(/\n/g, '<br>');
document.getElementById('reflectionContent').innerHTML = analysisData.reflection.replace(/\n/g, '<br>');
                document.getElementById('resultSection').style.display = 'block';
                document.getElementById('restartBtn').style.display = 'block';
                
            } catch (error) {
                console.error('APIè°ƒç”¨é”™è¯¯:', error);
                document.getElementById('resultContent').innerHTML = 
                    'æŠ±æ­‰ï¼Œåˆ†æè¿‡ç¨‹ä¸­å‡ºç°äº†ä¸€äº›é—®é¢˜ã€‚è¯·ç¨åå†è¯•ï¼Œæˆ–è€…æ£€æŸ¥æ‚¨çš„ç½‘ç»œè¿æ¥ã€‚';
                document.getElementById('consequenceContent').innerHTML = 
                    'æ— æ³•è·å–è¯¦ç»†çš„ç»“æœåˆ†æã€‚';
                document.getElementById('lifeReviewContent').innerHTML = 
                    'æ— æ³•ç”Ÿæˆå†³ç­–å›é¡¾ã€‚';
                document.getElementById('endingContent').innerHTML = 'æš‚æ—¶æ— æ³•ç”Ÿæˆæœ€ç»ˆç»“å±€ï¼Œè¯·ç¨åé‡è¯•ã€‚';
                document.getElementById('reflectionContent').innerHTML = 
                    'å»ºè®®æ‚¨å›é¡¾è‡ªå·±çš„å†³ç­–è¿‡ç¨‹ï¼Œæ€è€ƒå“ªäº›å› ç´ å½±å“äº†æ‚¨çš„é€‰æ‹©ã€‚';
                document.getElementById('resultSection').style.display = 'block';
                document.getElementById('restartBtn').style.display = 'block';
            } finally {
                document.getElementById('loading').style.display = 'none';
                hideLoading();
            }
        }

        // åˆå§‹åŒ–é¡µé¢
        function initPage() {
            // åˆå§‹åŒ–æ­¥éª¤æŒ‡ç¤ºå™¨
            initStepIndicators();

  // ä¸»é¢˜ chips & æ¨¡æ¿è”åŠ¨
      $('problemCats').innerHTML=problemCats.map(v=>`<span class="chip" data-value="${v}">${v}</span>`).join('');
      $('problemCats').addEventListener('click',e=>{
        const t=e.target.closest('.chip'); if(!t) return;
        [...$('problemCats').querySelectorAll('.chip')].forEach(n=>n.classList.remove('selected'));
        t.classList.add('selected');
        const cat=t.dataset.value; const list=categoryTemplates[cat]||[];
        const wrap=$('problemTemplatesWrap'), box=$('problemTemplates');
        if(list.length){ wrap.style.display='block'; box.innerHTML=list.map(x=>`<span class="chip" data-value="${x}">${x}</span>`).join('');
          box.onclick=(ev)=>{ const ch=ev.target.closest('.chip'); if(!ch) return; [...box.querySelectorAll('.chip')].forEach(n=>n.classList.remove('selected')); ch.classList.add('selected'); if(!$('problem').value){$('problem').value=`ã€ä¸»é¢˜ã€‘${cat}ï½œã€æ¨¡æ¿ã€‘${ch.dataset.value}ï½œã€å…³é”®é¡¾è™‘ã€‘ï¼ˆè¯·è¡¥å……1-2ç‚¹ï¼‰ï½œã€ç›®æ ‡ã€‘ï¼ˆè¯·è¡¥å……ï¼‰`;}}
        }else{ wrap.style.display='none'; box.innerHTML=''; }
      });

      // æ€§æ ¼/èƒŒæ™¯æ ‡ç­¾
      $('personalityChips').innerHTML=personalityPool.map(v=>`<span class="chip" data-value="${v}">${v}</span>`).join('');
      $('bgChips').innerHTML=bgPool.map(v=>`<span class="chip" data-value="${v}">${v}</span>`).join('');
      // è®©æ€§æ ¼æ ‡ç­¾å¯ç‚¹
bindChips('personalityChips',{
  multiple:true,
  onChange:(values)=>{ 
    $('personality').value = values.join('ã€'); 
  }
});

// è®©èƒŒæ™¯æ ‡ç­¾å¯ç‚¹
bindChips('bgChips',{
  multiple:true,
  onChange:(values)=>{ 
    $('background').value = values.join('ã€'); 
  }
});

      // è¡Œä¸šâ†’å²—ä½ + å…¶ä»–ï¼ˆè¯·å¡«å†™ï¼‰
      const OTHER_ROLE='å…¶ä»–ï¼ˆè¯·å¡«å†™ï¼‰';
      $('industry').addEventListener('change',e=>{
        const ind=e.target.value; const roleSel=$('role'); roleSel.innerHTML='';
        if(!ind){roleSel.disabled=true; roleSel.innerHTML='<option value="">è¯·å…ˆé€‰æ‹©è¡Œä¸š</option>'; $('roleOtherWrap').style.display='none'; $('roleOther').value=''; $('profession').value=''; return;}
        const roles=(rolesMap[ind]||[]).slice(); if(!roles.includes(OTHER_ROLE)) roles.push(OTHER_ROLE);
        roleSel.disabled=false; roleSel.innerHTML=['<option value="">è¯·é€‰æ‹©å²—ä½</option>',...roles.map(r=>`<option>${r}</option>`)].join('');
        $('roleOtherWrap').style.display='none'; $('roleOther').value=''; $('profession').value=ind;
      });
      $('role').addEventListener('change',e=>{
        const ind=$('industry').value; const role=e.target.value;
        if(role===OTHER_ROLE){ $('roleOtherWrap').style.display='block'; $('profession').value=ind; }
        else{ $('roleOtherWrap').style.display='none'; $('roleOther').value=''; $('profession').value = (ind && role)? `${ind}-${role}` : (ind||''); }
      });
      $('roleOther').addEventListener('input',e=>{
        const ind=$('industry').value; const custom=e.target.value.trim();
        $('profession').value = custom ? (ind ? `${ind}-${custom}` : custom) : (ind||'');
      });

      // MBTI å¿«é€‰ + 16å‹ chips
      const quickPicks=[
        {label:"ç†æ€§è§„åˆ’",type:"INTJ"},
        {label:"æ‰§è¡Œä¸»å¯¼",type:"ESTJ"},
        {label:"åˆ›æ„æ¢ç´¢",type:"ENFP"},
        {label:"å…±æƒ…æ²Ÿé€š",type:"ENFJ"},
        {label:"çµæ´»åº”å˜",type:"ESTP"},
        {label:"æ¸©æš–å®ˆæŠ¤",type:"ISFJ"}
      ];
      $('mbtiQuick').innerHTML=quickPicks.map(q=>`<span class="chip" data-type="${q.type}" title="${q.type}ï¼š${mbtiExplain[q.type]}">${q.label}ï¼ˆ${q.type}ï¼‰</span>`).join('');
      $('mbtiChips').innerHTML=mbtiOrder.map(t=>`<span class="chip" data-type="${t}" title="${mbtiExplain[t]}">${t}</span>`).join('');

      function selectMBTI(type){
        // é«˜äº® 16 å‹ chips
        [...$('mbtiChips').querySelectorAll('.chip')].forEach(n=>n.classList.toggle('selected', n.dataset.type===type));
        // é«˜äº®å¿«é€‰
        [...$('mbtiQuick').querySelectorAll('.chip')].forEach(n=>n.classList.toggle('selected', n.dataset.type===type));
        $('mbti').value=type||''; updateMBTIExplain(type);
      }
      $('mbtiChips').addEventListener('click',e=>{const chip=e.target.closest('.chip'); if(!chip) return; selectMBTI(chip.dataset.type);});
      $('mbtiQuick').addEventListener('click',e=>{const chip=e.target.closest('.chip'); if(!chip) return; selectMBTI(chip.dataset.type);});

    

            
            // æ­¥éª¤1æŒ‰é’®äº‹ä»¶
            document.getElementById('nextStep1').addEventListener('click', () => {
                if (validateStep1()) {
                    const button = document.getElementById('nextStep1');
                    button.disabled = true;
                    button.textContent = 'å¤„ç†ä¸­...';
                    
                    goToStep(2);
                    displayCharacterBadges();
                    generateFirstStory().finally(() => {
                        button.disabled = false;
                        button.textContent = 'ä¸‹ä¸€æ­¥';
                    });
                } else {
                    alert('è¯·å¡«å†™å®Œæ•´ä¿¡æ¯');
                }
            });
            
            // æ­¥éª¤2æŒ‰é’®äº‹ä»¶
            document.getElementById('nextStep2').addEventListener('click', async () => {
                const button = document.getElementById('nextStep2');
                button.disabled = true;
                button.textContent = 'ç”Ÿæˆæ•…äº‹ä¸­...';
                
                await generateSecondStory();
                goToStep(3);
                
                button.disabled = false;
                button.textContent = 'ä¸‹ä¸€æ­¥';
            });
            
            document.getElementById('backStep2').addEventListener('click', () => {
                goToStep(1);
            });
            
            // æ­¥éª¤3æŒ‰é’®äº‹ä»¶
            document.getElementById('nextStep3').addEventListener('click', async () => {
                const button = document.getElementById('nextStep3');
                button.disabled = true;
                button.textContent = 'ç”Ÿæˆæ•…äº‹ä¸­...';
                
                await generateThirdStory();
                goToStep(4);
                
                button.disabled = false;
                button.textContent = 'ä¸‹ä¸€æ­¥';
            });
            
            document.getElementById('backStep3').addEventListener('click', () => {
                goToStep(2);
            });
            
            // æ­¥éª¤4æŒ‰é’®äº‹ä»¶
            document.getElementById('nextStep4').addEventListener('click', () => {
                const button = document.getElementById('nextStep4');
                button.disabled = true;
                button.textContent = 'åˆ†æä¸­...';
                
                goToStep(5);
                generateFinalAnalysis().finally(() => {
                    button.disabled = false;
                    button.textContent = 'ä¸‹ä¸€æ­¥';
                });
            });
            
            document.getElementById('backStep4').addEventListener('click', () => {
                goToStep(3);
            });
            
            // æ­¥éª¤5æŒ‰é’®äº‹ä»¶
            document.getElementById('backStep5').addEventListener('click', () => {
                goToStep(4);
            });
            
            document.getElementById('restartBtn').addEventListener('click', () => {
                // é‡ç½®çŠ¶æ€
                state.currentStep = 1;
                state.userSelections = {
                    name: '',
                    age: '',
                    profession: '',
                    personality: '',
                    background: '',
                    mbti: '',
                    problem: '',
                    decisions: []
                };
                
                // é‡ç½®è¡¨å•
                document.getElementById('name').value = '';
                document.getElementById('age').value = '';
                document.getElementById('profession').value = '';
                document.getElementById('personality').value = '';
                document.getElementById('background').value = '';
                document.getElementById('mbti').value = '';
                document.getElementById('problem').value = '';
                
                // éšè—ç»“æœ
                document.getElementById('resultSection').style.display = 'none';
                document.getElementById('restartBtn').style.display = 'none';
                
                // å›åˆ°ç¬¬ä¸€æ­¥
                goToStep(1);
            });
        }

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        window.addEventListener('load', initPage);
    </script>
</body>
</html>